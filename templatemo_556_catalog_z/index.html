<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MovieDck</title>
  <!-- Google Fonts for classy branding -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=DM+Serif+Display&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    /* ... your existing styles unchanged ... */
    /* (Due to length, styles are the same as previous code; include all your styles here) */
  </style>
</head>
<body>
  <!-- Movie Player Modal -->
  <div class="modal" id="modal" aria-modal="true" role="dialog" aria-hidden="true">
    <div class="modal-content" id="modal-content-movie">
      <span class="close" onclick="closeModal()" role="button" tabindex="0" aria-label="Close modal">×</span>
      <div class="modal-body">
        <img id="modal-image" src="" alt="Poster" />
        <div class="modal-text">
          <h2 id="modal-title"></h2>
          <div class="stars" id="modal-rating"></div>
          <div class="modal-genre" id="modal-genres"></div>
          <p id="modal-description"></p>
          <div class="modal-cast" id="modal-cast"></div>
          <div class="modal-crew" id="modal-crew"></div>
          <div class="modal-trailer" id="modal-trailer"></div>
          <button class="share-btn" id="share-movie-btn" onclick="shareMovie()">Share</button>
        </div>
      </div>
      <div class="server-selector">
        <label for="server">Change Server:</label>
        <select id="server" onchange="changeServer()">
          <option value="player.videasy.net">Player.Videasy.net</option>
          <option value="vidsrc.cc">Vidsrc.cc</option>
          <option value="vidsrc.me">Vidsrc.me</option>
          <option value="vidsrc.to">Vidsrc.to</option>
        </select>
      </div>
      <div class="iframe-container">
        <iframe id="modal-video" allowfullscreen autoplay></iframe>
        <button class="iframe-play-overlay" onclick="triggerIframePlay('modal-video')" aria-label="Play video">
          <i class="fas fa-play"></i>
        </button>
      </div>
      <div id="similar-movies" style="padding: 1rem 2rem;"></div>
    </div>
    <!-- TV Modal Content -->
    <div class="modal-content" id="modal-content-tv" style="display: none;">
      <span class="close" onclick="closeTvModal()" role="button" tabindex="0" aria-label="Close TV modal">×</span>
      <div class="modal-body">
        <img id="tv-modal-image" src="" alt="Poster" />
        <div class="modal-text">
          <h2 id="tv-modal-title"></h2>
          <div class="modal-genre" id="tv-modal-genres"></div>
          <p id="tv-modal-description"></p>
          <div><strong>First Air Date:</strong> <span id="tv-modal-air-date"></span></div>
          <div><strong>Seasons:</strong> <span id="tv-modal-total-seasons"></span></div>
          <button class="share-btn" id="share-tv-btn" onclick="shareTvShow()" style="margin-bottom: 1em;">Share</button>
          <button class="favorite-btn" id="tv-favorite-btn" title="Add to favorites" aria-label="Add to favorites" tabindex="0">
            <i class="fas fa-heart"></i>
          </button>
          <div id="tv-modal-seasons-list"></div>
        </div>
      </div>
      <div class="iframe-container">
        <iframe id="tv-episode-player" allowfullscreen autoplay style="display: none;"></iframe>
        <button class="iframe-play-overlay" onclick="triggerIframePlay('tv-episode-player')" aria-label="Play TV episode">
          <i class="fas fa-play"></i>
        </button>
      </div>
      <div style="display: flex; justify-content: center;">
        <button class="tv-episode-next-btn" id="tv-episode-next-btn" style="display: none; margin-bottom: 1em;">Next Episode »</button>
      </div>
    </div>
  </div>

  <!-- ... your existing navigation, hero, filters, movie list, footer, back-to-top button ... -->

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.1/umd/popper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.min.js"></script>
  <script>
    // Your existing variables and functions here (apiKey, imageBaseUrl, favorites, etc.)

    // TV Modal details and episodes loading
    async function showTvDetails(tv) {
      document.getElementById('modal-content-movie').style.display = 'none';
      document.getElementById('modal-content-tv').style.display = '';
      document.getElementById('modal').style.display = 'flex';
      tvModalData.tvId = tv.id;
      tvModalData.seasons = tv.seasons || [];
      tvModalData.season = tv.seasons && tv.seasons.length ? tv.seasons[0].season_number : 1;
      tvModalData.episode = null;

      addRecentlyViewed({ ...tv, media_type: 'tv' });

      document.getElementById('tv-modal-title').textContent = tv.name || '';
      document.getElementById('tv-modal-description').textContent = tv.overview || '';
      document.getElementById('tv-modal-image').src = tv.poster_path ? imageBaseUrl + tv.poster_path : 'img/no-poster.png';
      document.getElementById('tv-modal-air-date').textContent = tv.first_air_date || '';
      document.getElementById('tv-modal-total-seasons').textContent = tv.number_of_seasons || tv.seasons?.length || '';
      document.getElementById('tv-modal-genres').innerHTML = (tv.genres || []).map(g => `<span class="chip">${g.name}</span>`).join(' ');

      // Favorite button state
      const tvFavoriteBtn = document.getElementById('tv-favorite-btn');
      if (isFavorite(tv.id, 'tv')) tvFavoriteBtn.classList.add('favorited');
      else tvFavoriteBtn.classList.remove('favorited');

      tvFavoriteBtn.onclick = (e) => {
        e.stopPropagation();
        toggleFavorite(tv.id, 'tv');
      };

      // Load seasons list
      const seasonsListDiv = document.getElementById('tv-modal-seasons-list');
      seasonsListDiv.innerHTML = '';
      tvModalData.seasons.forEach(season => {
        const seasonDiv = document.createElement('div');
        seasonDiv.className = 'season-block';

        const header = document.createElement('div');
        header.className = 'season-header';
        header.textContent = `Season ${season.season_number} (${season.episode_count} episodes)`;
        header.tabIndex = 0;
        header.setAttribute('role', 'button');
        header.setAttribute('aria-expanded', 'false');

        const episodesList = document.createElement('div');
        episodesList.className = 'episodes-list';
        episodesList.style.display = 'none';

        header.onclick = () => {
          const expanded = header.getAttribute('aria-expanded') === 'true';
          header.setAttribute('aria-expanded', expanded ? 'false' : 'true');
          episodesList.style.display = expanded ? 'none' : 'block';
        };
        header.onkeypress = (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            header.click();
          }
        };

        seasonDiv.appendChild(header);
        seasonDiv.appendChild(episodesList);
        seasonsListDiv.appendChild(seasonDiv);

        // Fetch episodes for this season
        fetchSeasonEpisodes(tv.id, season.season_number, episodesList);
      });

      // Hide episode player initially
      const episodePlayer = document.getElementById('tv-episode-player');
      episodePlayer.style.display = 'none';
      document.querySelector('#modal-content-tv .iframe-play-overlay').style.display = 'flex';
      document.getElementById('tv-episode-next-btn').style.display = 'none';
    }

    async function fetchSeasonEpisodes(tvId, seasonNumber, container) {
      container.innerHTML = '<p>Loading episodes...</p>';
      try {
        const response = await fetch(`https://api.themoviedb.org/3/tv/${tvId}/season/${seasonNumber}?api_key=${apiKey}&language=en-US`);
        if (!response.ok) throw new Error('Failed to fetch season episodes');
        const data = await response.json();
        container.innerHTML = '';
        data.episodes.forEach(episode => {
          const epDiv = document.createElement('div');
          epDiv.className = 'episode-block';
          epDiv.tabIndex = 0;
          epDiv.setAttribute('role', 'button');
          epDiv.setAttribute('aria-label', `Play episode ${episode.episode_number}: ${episode.name}`);

          const epNumSpan = document.createElement('span');
          epNumSpan.textContent = `Ep ${episode.episode_number}: ${episode.name}`;

          const playBtn = document.createElement('button');
          playBtn.className = 'tv-episode-play-btn';
          playBtn.textContent = 'Play';
          playBtn.onclick = (e) => {
            e.stopPropagation();
            playTvEpisode(tvId, seasonNumber, episode.episode_number);
          };

          epDiv.appendChild(epNumSpan);
          epDiv.appendChild(playBtn);

          epDiv.onclick = () => playTvEpisode(tvId, seasonNumber, episode.episode_number);
          epDiv.onkeypress = (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              epDiv.click();
            }
          };

          container.appendChild(epDiv);
        });
      } catch (e) {
        container.innerHTML = '<p class="error-state">Failed to load episodes.</p>';
        console.error(e);
      }
    }

    async function playTvEpisode(tvId, seasonNumber, episodeNumber) {
      tvModalData.season = seasonNumber;
      tvModalData.episode = episodeNumber;

      const iframe = document.getElementById('tv-episode-player');
      const playOverlay = iframe.parentElement.querySelector('.iframe-play-overlay');

      // Build embed URL (example using vidsrc.cc, can add server selection if desired)
      // You may want to add server selection like movie modal, here simplified:
      const embedURL = `https://vidsrc.cc/embed/tv/${tvId}/${seasonNumber}/${episodeNumber}`;

      iframe.src = embedURL;
      iframe.style.display = 'block';
      playOverlay.style.display = 'none';

      // Show Next Episode button if next episode exists
      const nextBtn = document.getElementById('tv-episode-next-btn');
      const nextEpisodeNumber = episodeNumber + 1;
      const season = tvModalData.seasons.find(s => s.season_number === seasonNumber);
      if (season && nextEpisodeNumber <= season.episode_count) {
        nextBtn.style.display = 'inline-block';
        nextBtn.onclick = () => playTvEpisode(tvId, seasonNumber, nextEpisodeNumber);
      } else {
        nextBtn.style.display = 'none';
      }
    }

    // The rest of your existing code (movie modal, favorites, filters, infinite scroll, etc.) remains unchanged.
    // Just ensure you include all previous code for filters, Netflix toggle, infinite scroll, favorites, modal handling, etc.

    // For brevity, the rest of your previous JavaScript code remains here unchanged,
    // including fetchMoviesInf, renderMovies, loadMoreMovies, toggleFavorite, etc.

    // Initial load and other event handlers should remain as before.

  </script>
</body>
</html>
