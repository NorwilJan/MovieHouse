<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MovieDck - Cinematic Hub</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- Plyr.js -->
  <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(180deg, #0f1218 0%, #1a1f25 100%);
      color: #e5e7eb;
    }
    h1, h2, h3 {
      font-family: 'Playfair Display', serif;
    }
    .glass-card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
    }
    .poster-img {
      transition: transform 0.3s, opacity 0.3s;
      opacity: 0.7;
      border-radius: 8px;
    }
    .poster-img.loaded {
      opacity: 1;
    }
    .poster-card:hover .poster-img {
      transform: scale(1.05);
      opacity: 1;
    }
    .carousel-item {
      transition: opacity 0.5s ease, transform 0.5s ease;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(10, 12, 16, 0.95);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .plyr--video {
      border-radius: 8px;
      max-height: 50vh;
      width: 100%;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
      margin: auto;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .sidebar {
      transition: transform 0.3s ease;
    }
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .plyr--video {
        max-height: 40vh;
      }
    }
  </style>
</head>
<body class="antialiased">
  <!-- Sidebar -->
  <div class="fixed inset-y-0 left-0 w-64 bg-gray-900 glass-card p-6 sidebar z-20" id="sidebar">
    <div class="flex items-center mb-8">
      <h1 class="text-2xl text-white">MovieDck</h1>
      <button class="ml-auto text-white md:hidden" id="close-sidebar">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <nav>
      <a href="#" class="block py-2 text-white hover:text-blue-400 active" id="nav-movies">Movies</a>
      <a href="#" class="block py-2 text-white hover:text-blue-400" id="nav-tvshows">TV Shows</a>
      <a href="#" class="block py-2 text-white hover:text-blue-400" id="nav-anime">Anime</a>
      <a href="#" class="block py-2 text-white hover:text-blue-400" id="nav-tagalog">Tagalog</a>
      <a href="#" class="block py-2 text-white hover:text-blue-400" id="nav-netflix">Netflix</a>
      <a href="#" class="block py-2 text-white hover:text-blue-400" id="nav-favorites">
        <i class="fas fa-heart mr-2"></i>Favorites
      </a>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="min-h-screen ml-0 md:ml-64 transition-all">
    <!-- Mobile Menu Button -->
    <button class="fixed top-4 left-4 text-white md:hidden z-30" id="open-sidebar">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Hero Carousel -->
    <div class="relative h-96 mb-8" id="hero-carousel">
      <div class="absolute inset-0 carousel-item opacity-0" id="carousel-item-1">
        <img class="w-full h-full object-cover opacity-50" src="" alt="Featured">
        <div class="absolute inset-0 flex items-center justify-center">
          <div class="text-center text-white">
            <h2 class="text-3xl mb-2"></h2>
            <button class="bg-blue-600 text-white px-4 py-2 rounded" onclick="playFeatured(1)">Watch Now</button>
          </div>
        </div>
      </div>
      <!-- Add more carousel items as needed -->
      <div class="spinner absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" id="carousel-spinner"></div>
    </div>

    <!-- Search Bar -->
    <div class="max-w-2xl mx-auto mb-8 px-4">
      <form class="flex" id="movie-search-form">
        <input type="search" id="movie-search-input" class="w-full p-3 rounded-l-lg bg-gray-800 text-white border-none focus:ring-2 focus:ring-blue-600" placeholder="Search movies or TV shows..." aria-label="Search">
        <button type="submit" class="bg-blue-600 text-white px-4 rounded-r-lg" aria-label="Search">
          <i class="fas fa-search"></i>
        </button>
      </form>
    </div>

    <!-- Recently Viewed -->
    <div class="px-4 mb-8" id="recently-viewed-section" style="display:none;">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl text-white">Recently Viewed</h2>
        <button class="text-blue-400 hover:text-blue-300" id="clear-recent-btn">Clear</button>
      </div>
      <div class="flex gap-4 overflow-x-auto pb-4" id="recently-viewed-list"></div>
    </div>

    <!-- Movie/TV Grid -->
    <div class="px-4">
      <h2 class="text-2xl text-white mb-4" id="section-title">Trending Movies</h2>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="movie-list"></div>
      <div class="spinner mt-8" id="infinite-loader" style="display:none;"></div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal">
    <div class="max-w-4xl w-full mx-4 glass-card p-6 relative">
      <button class="absolute top-4 right-4 text-white text-2xl" onclick="closeModal()" aria-label="Close modal">
        <i class="fas fa-times"></i>
      </button>
      <!-- Movie Modal -->
      <div id="modal-content-movie">
        <div class="flex flex-col md:flex-row gap-6">
          <img id="modal-image" class="w-48 rounded-lg" src="" alt="Poster">
          <div class="flex-1">
            <h2 id="modal-title" class="text-3xl text-white mb-2"></h2>
            <div class="flex items-center mb-2" id="modal-rating"></div>
            <div class="flex gap-2 mb-2" id="modal-genres"></div>
            <p id="modal-description" class="text-gray-300"></p>
            <p id="modal-cast" class="text-gray-300"></p>
            <p id="modal-crew" class="text-gray-300"></p>
            <a id="modal-trailer" class="text-blue-400 hover:text-blue-300" target="_blank"></a>
            <button class="mt-4 bg-blue-600 text-white px-4 py-2 rounded" onclick="shareMovie()" aria-label="Share movie">Share</button>
          </div>
        </div>
        <div class="mt-4">
          <label for="server" class="text-white mr-2">Server:</label>
          <select id="server" onchange="changeServer()" class="bg-gray-800 text-white p-2 rounded" aria-label="Select video server">
            <option value="vidcdn.one">VidCDN</option>
            <option value="vidsrc.me">VidSrc.me</option>
          </select>
        </div>
        <div class="mt-4 relative">
          <video id="modal-video" controls></video>
          <div class="spinner absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" style="display:none;" id="video-spinner"></div>
        </div>
      </div>
      <!-- TV Modal -->
      <div id="modal-content-tv" style="display:none;">
        <div class="flex flex-col md:flex-row gap-6">
          <img id="tv-modal-image" class="w-48 rounded-lg" src="" alt="Poster">
          <div class="flex-1">
            <h2 id="tv-modal-title" class="text-3xl text-white mb-2"></h2>
            <div class="flex gap-2 mb-2" id="tv-modal-genres"></div>
            <p id="tv-modal-description" class="text-gray-300"></p>
            <p><strong>First Air:</strong> <span id="tv-modal-air-date"></span></p>
            <p><strong>Seasons:</strong> <span id="tv-modal-total-seasons"></span></p>
            <button class="mt-4 bg-blue-600 text-white px-4 py-2 rounded" onclick="shareTvShow()" aria-label="Share TV show">Share</button>
            <div id="tv-modal-seasons-list" class="mt-4 max-h-64 overflow-y-auto"></div>
          </div>
        </div>
        <div class="mt-4 relative">
          <video id="tv-episode-player" controls style="display:none;"></video>
          <div class="spinner absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2" style="display:none;" id="tv-video-spinner"></div>
        </div>
        <button class="mt-4 bg-blue-600 text-white px-4 py-2 rounded" id="tv-episode-next-btn" style="display:none;" aria-label="Next episode">Next Episode</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
  <script src="https://cdn.plyr.io/3.7.8/plyr.polyfilled.js"></script>
  <script>
    const apiKey = '40f1982842db35042e8561b13b38d492';
    const imageBaseUrl = 'https://image.tmdb.org/t/p/';
    let lastModalMovie = null;
    let currentPage = 1;
    let totalPages = 1;
    let currentMode = 'popular';
    let currentQuery = '';
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    let netflixType = 'movie';
    let tvModalData = { tvId: null, season: null, episode: null, seasons: [] };
    let players = {};

    // Adaptive Image Size
    function getImageSize() {
      return window.innerWidth < 768 ? 'w300' : 'w500';
    }

    // Progressive Image Loading
    function loadProgressiveImage(img, highResSrc) {
      const lowResSrc = highResSrc.replace('/w500', '/w92');
      img.src = lowResSrc;
      img.style.opacity = '0.7';
      const highRes = new Image();
      highRes.src = highResSrc;
      highRes.onload = () => {
        img.src = highResSrc;
        img.classList.add('loaded');
      };
    }

    // Favorites & Recently Viewed
    function isFavorite(id) { return favorites.includes(id); }
    function toggleFavorite(id) {
      favorites = isFavorite(id) ? favorites.filter(f => f !== id) : [...favorites, id];
      localStorage.setItem('favorites', JSON.stringify(favorites));
      if (currentMode === 'favorites') renderFavorites();
      document.querySelectorAll('.favorite-btn').forEach(btn => {
        if (btn.dataset.id == id) {
          btn.classList.toggle('text-red-500', isFavorite(id));
        }
      });
    }
    let recentlyViewed = JSON.parse(localStorage.getItem('recently_viewed') || '[]');
    function addRecentlyViewed(item) {
      const isTv = !!item.name && !item.title;
      recentlyViewed = recentlyViewed.filter(m => m.id !== item.id || m.isTv !== isTv);
      recentlyViewed.unshift({
        id: item.id,
        title: isTv ? item.name : item.title,
        poster_path: item.poster_path,
        release_date: isTv ? item.first_air_date : item.release_date,
        isTv,
        timestamp: Date.now()
      });
      if (recentlyViewed.length > 12) recentlyViewed = recentlyViewed.slice(0, 12);
      localStorage.setItem('recently_viewed', JSON.stringify(recentlyViewed));
      renderRecentlyViewed();
    }
    function clearRecentlyViewed() {
      recentlyViewed = [];
      localStorage.setItem('recently_viewed', '[]');
      renderRecentlyViewed();
    }
    function renderRecentlyViewed() {
      const section = document.getElementById('recently-viewed-section');
      const list = document.getElementById('recently-viewed-list');
      const clearBtn = document.getElementById('clear-recent-btn');
      if (!recentlyViewed.length) {
        section.style.display = 'none';
        clearBtn.style.display = 'none';
        return;
      }
      section.style.display = 'block';
      clearBtn.style.display = 'block';
      list.innerHTML = '';
      recentlyViewed.sort((a, b) => b.timestamp - a.timestamp).forEach(item => {
        const div = document.createElement('div');
        div.className = 'w-32 flex-shrink-0';
        div.innerHTML = `
          <div class="poster-card cursor-pointer">
            <img src="${item.poster_path ? imageBaseUrl + 'w92' + item.poster_path : 'img/no-poster.png'}" alt="${item.title}" class="poster-img w-full">
            <p class="text-sm text-white mt-2 truncate">${item.title}</p>
          </div>
        `;
        const img = div.querySelector('.poster-img');
        if (item.poster_path) loadProgressiveImage(img, imageBaseUrl + getImageSize() + item.poster_path);
        div.onclick = () => fetch(`https://api.themoviedb.org/3/${item.isTv ? 'tv' : 'movie'}/${item.id}?api_key=${apiKey}`)
          .then(r => r.json()).then(data => item.isTv ? showTvDetails(data) : showDetails(data));
        list.appendChild(div);
      });
    }

    // Fetch Movies
    async function fetchMoviesInf(page = 1) {
      if (!navigator.onLine) {
        showError('You are offline. Please check your connection.');
        return [];
      }
      let url = '';
      if (currentMode === 'favorites') {
        renderFavorites();
        return [];
      }
      if (currentMode === 'search' && currentQuery.trim()) {
        url = `https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(currentQuery)}&page=${page}&include_adult=false`;
      } else if (currentMode === 'anime') {
        url = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&with_genres=16&with_original_language=ja&sort_by=popularity.desc&page=${page}`;
      } else if (currentMode === 'tagalog') {
        url = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&with_original_language=tl&sort_by=popularity.desc&page=${page}`;
      } else if (currentMode === 'tv') {
        url = `https://api.themoviedb.org/3/trending/tv/day?api_key=${apiKey}&page=${page}`;
      } else if (currentMode === 'netflix') {
        url = `https://api.themoviedb.org/3/discover/${netflixType}?api_key=${apiKey}&with_watch_providers=8&watch_region=US&sort_by=popularity.desc&page=${page}`;
      } else {
        url = `https://api.themoviedb.org/3/trending/movie/day?api_key=${apiKey}&page=${page}`;
      }
      try {
        const response = await fetch(url);
        const data = await response.json();
        totalPages = data.total_pages || 1;
        return data.results || [];
      } catch (e) {
        showError('Failed to load content. Please try again.');
        return [];
      }
    }

    // Render Movies
    function renderMovies(movies, clear = false) {
      const container = document.getElementById('movie-list');
      if (clear) container.innerHTML = '';
      if (!movies.length) {
        container.innerHTML = '<p class="text-gray-400 col-span-full text-center">No items found.</p>';
        return;
      }
      movies.forEach(item => {
        const isTv = !!item.name && !item.title;
        const div = document.createElement('div');
        div.className = 'poster-card';
        div.innerHTML = `
          <div class="relative">
            <img src="${item.poster_path ? imageBaseUrl + 'w92' + item.poster_path : 'img/no-poster.png'}" alt="${isTv ? item.name : item.title}" class="poster-img w-full">
            <button class="absolute top-2 right-2 text-white favorite-btn ${isFavorite(item.id) ? 'text-red-500' : ''}" data-id="${item.id}" aria-label="Toggle favorite">
              <i class="fas fa-heart"></i>
            </button>
            <button class="absolute inset-0 bg-blue-600 bg-opacity-0 hover:bg-opacity-50 transition-opacity rounded-lg flex items-center justify-center play-btn" aria-label="${isTv ? 'View TV Show' : 'Play Movie'}">
              <i class="fas fa-${isTv ? 'tv' : 'play'} text-white text-2xl"></i>
            </button>
          </div>
          <p class="text-sm text-white mt-2 truncate">${isTv ? item.name : item.title}</p>
          <p class="text-xs text-gray-400">${(isTv ? item.first_air_date : item.release_date)?.slice(0, 4) || ''}</p>
        `;
        const img = div.querySelector('.poster-img');
        if (item.poster_path) loadProgressiveImage(img, imageBaseUrl + getImageSize() + item.poster_path);
        div.querySelector('.play-btn').onclick = () => isTv ? showTvDetails(item) : showDetails(item);
        div.querySelector('.favorite-btn').onclick = (e) => {
          e.stopPropagation();
          toggleFavorite(item.id);
        };
        container.appendChild(div);
      });
    }

    // Infinite Scroll
    let isLoading = false;
    let reachedEnd = false;
    async function loadMoreMovies(clear = false) {
      if (isLoading || reachedEnd) return;
      isLoading = true;
      document.getElementById('infinite-loader').style.display = 'block';
      const movies = await fetchMoviesInf(currentPage);
      if (movies.length) {
        renderMovies(movies, clear);
        currentPage++;
        if (currentPage > totalPages) reachedEnd = true;
      } else {
        reachedEnd = true;
      }
      isLoading = false;
      document.getElementById('infinite-loader').style.display = 'none';
    }

    // Hero Carousel
    function initCarousel() {
      fetch(`https://api.themoviedb.org/3/trending/all/day?api_key=${apiKey}`)
        .then(r => r.json())
        .then(data => {
          const items = data.results.slice(0, 3);
          items.forEach((item, i) => {
            const div = document.getElementById(`carousel-item-${i + 1}`);
            if (div) {
              div.querySelector('img').src = item.backdrop_path ? imageBaseUrl + 'w1280' + item.backdrop_path : 'img/no-poster.png';
              div.querySelector('h2').textContent = item.title || item.name;
              div.dataset.id = item.id;
              div.dataset.isTv = !!item.name && !item.title;
            }
          });
          document.getElementById('carousel-spinner').style.display = 'none';
          let current = 1;
          setInterval(() => {
            document.querySelectorAll('.carousel-item').forEach(item => item.classList.add('opacity-0'));
            document.getElementById(`carousel-item-${current}`).classList.remove('opacity-0');
            current = current % 3 + 1;
          }, 5000);
        });
    }

    // Movie Modal
    async function showDetails(movie) {
      document.getElementById('modal-content-movie').style.display = 'block';
      document.getElementById('modal-content-tv').style.display = 'none';
      document.getElementById('modal').style.display = 'flex';
      lastModalMovie = movie;
      addRecentlyViewed(movie);
      document.getElementById('modal-title').textContent = movie.title;
      document.getElementById('modal-description').textContent = movie.overview || 'No description available.';
      const modalImg = document.getElementById('modal-image');
      if (movie.poster_path) loadProgressiveImage(modalImg, imageBaseUrl + getImageSize() + movie.poster_path);
      else modalImg.src = 'img/no-poster.png';
      document.getElementById('modal-rating').innerHTML = `${getStars(movie.vote_average || 0)} (${movie.vote_average || 'N/A'})`;
      document.getElementById('modal-genres').innerHTML = (movie.genres || []).map(g => `<span class="bg-blue-600 text-white px-2 py-1 rounded text-sm">${g.name}</span>`).join('');
      document.getElementById('modal-cast').textContent = 'Loading cast...';
      document.getElementById('modal-crew').textContent = '';
      document.getElementById('modal-trailer').innerHTML = '';
      fetch(`https://api.themoviedb.org/3/movie/${movie.id}/credits?api_key=${apiKey}`)
        .then(r => r.json())
        .then(data => {
          const cast = (data.cast || []).slice(0, 5).map(c => c.name).join(', ');
          const director = (data.crew || []).find(c => c.job === 'Director');
          document.getElementById('modal-cast').innerHTML = cast ? `<strong>Cast:</strong> ${cast}` : '';
          document.getElementById('modal-crew').innerHTML = director ? `<strong>Director:</strong> ${director.name}` : '';
        });
      fetch(`https://api.themoviedb.org/3/movie/${movie.id}/videos?api_key=${apiKey}`)
        .then(r => r.json())
        .then(data => {
          const yt = (data.results || []).find(v => v.site === 'YouTube' && v.type === 'Trailer');
          if (yt) {
            document.getElementById('modal-trailer').innerHTML = `▶ Watch Trailer`;
            document.getElementById('modal-trailer').href = `https://youtube.com/watch?v=${yt.key}`;
          }
        });
      document.getElementById('server').value = 'vidcdn.one';
      changeServer();
      GSAP.to('#modal', { opacity: 1, y: 0, duration: 0.3 });
    }

    // Player Setup
    function setupPlayer(videoId, sources) {
      if (players[videoId]) players[videoId].destroy();
      const video = document.getElementById(videoId);
      players[videoId] = new Plyr(video, {
        controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'captions', 'settings', 'fullscreen'],
        settings: ['quality', 'speed'],
        autoplay: true,
      });
      video.src = '';
      players[videoId].source = {
        type: 'video',
        sources,
      };
      players[videoId].on('error', () => {
        if (document.getElementById('server').value === 'vidcdn.one') {
          document.getElementById('server').value = 'vidsrc.me';
          changeServer();
          showError('Primary server failed. Switched to backup.');
        } else {
          showError('Video failed to load. Try another server.');
        }
      });
      players[videoId].on('loadeddata', () => {
        document.getElementById(`${videoId.includes('tv') ? 'tv-video' : 'video'}-spinner`).style.display = 'none';
      });
    }

    function changeServer() {
      const server = document.getElementById('server').value;
      const videoId = lastModalMovie?.media_type === 'tv' ? 'tv-episode-player' : 'modal-video';
      const spinnerId = videoId.includes('tv') ? 'tv-video-spinner' : 'video-spinner';
      document.getElementById(spinnerId).style.display = 'block';
      let sources = [];
      if (server === 'vidcdn.one') {
        sources = [
          { src: `https://vidcdn.one/movie/${lastModalMovie.id}.m3u8`, type: 'application/x-mpegURL', label: 'HD' },
          { src: `https://vidcdn.one/movie/${lastModalMovie.id}.mp4`, type: 'video/mp4', label: 'SD' },
        ];
      } else {
        sources = [{ src: `https://vidsrc.me/embed/movie/${lastModalMovie.id}`, type: 'video/mp4' }];
      }
      setupPlayer(videoId, sources);
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
      if (players['modal-video']) players['modal-video'].destroy();
      if (players['tv-episode-player']) players['tv-episode-player'].destroy();
      players = {};
    }

    // TV Modal
    async function showTvDetails(tv) {
      document.getElementById('modal-content-movie').style.display = 'none';
      document.getElementById('modal-content-tv').style.display = 'block';
      document.getElementById('modal').style.display = 'flex';
      const tvInfo = await fetch(`https://api.themoviedb.org/3/tv/${tv.id}?api_key=${apiKey}`).then(r => r.json());
      tvModalData.tvId = tvInfo.id;
      tvModalData.seasons = tvInfo.seasons;
      document.getElementById('tv-modal-title').textContent = tvInfo.name;
      const modalImg = document.getElementById('tv-modal-image');
      if (tvInfo.poster_path) loadProgressiveImage(modalImg, imageBaseUrl + getImageSize() + tvInfo.poster_path);
      else modalImg.src = 'img/no-poster.png';
      document.getElementById('tv-modal-description').textContent = tvInfo.overview || '';
      document.getElementById('tv-modal-air-date').textContent = tvInfo.first_air_date || '';
      document.getElementById('tv-modal-total-seasons').textContent = tvInfo.number_of_seasons;
      document.getElementById('tv-modal-genres').innerHTML = (tvInfo.genres || []).map(g => `<span class="bg-blue-600 text-white px-2 py-1 rounded text-sm">${g.name}</span>`).join('');
      document.getElementById('tv-modal-seasons-list').innerHTML = '';
      addRecentlyViewed(tv);
      tvInfo.seasons.forEach(season => {
        const div = document.createElement('div');
        div.className = 'mb-4';
        div.innerHTML = `
          <h3 class="text-lg text-white cursor-pointer" tabindex="0">${season.name} (${season.episode_count} eps)</h3>
          <div class="episodes-list hidden ml-4"></div>
        `;
        div.querySelector('h3').onclick = async () => {
          const epList = div.querySelector('.episodes-list');
          epList.classList.toggle('hidden');
          if (!epList.innerHTML) {
            const data = await fetch(`https://api.themoviedb.org/3/tv/${tv.id}/season/${season.season_number}?api_key=${apiKey}`).then(r => r.json());
            epList.innerHTML = (data.episodes || []).map(ep => `
              <div class="flex justify-between items-center py-1">
                <span>Ep ${ep.episode_number}: ${ep.name || '(Untitled)'}</span>
                <button class="bg-blue-600 text-white px-2 py-1 rounded" onclick="playTvEpisode('${tv.id}', '${season.season_number}', '${ep.episode_number}')">Play</button>
              </div>
            `).join('');
          }
        };
        document.getElementById('tv-modal-seasons-list').appendChild(div);
      });
    }

    function playTvEpisode(tvId, seasonNum, episodeNum) {
      lastModalMovie = { id: tvId, media_type: 'tv' };
      const video = document.getElementById('tv-episode-player');
      video.style.display = 'block';
      document.getElementById('tv-video-spinner').style.display = 'block';
      const sources = [
        { src: `https://vidcdn.one/tv/${tvId}/${seasonNum}/${episodeNum}.m3u8`, type: 'application/x-mpegURL', label: 'HD' },
        { src: `https://vidcdn.one/tv/${tvId}/${seasonNum}/${episodeNum}.mp4`, type: 'video/mp4', label: 'SD' },
      ];
      setupPlayer('tv-episode-player', sources);
      tvModalData.season = parseInt(seasonNum);
      tvModalData.episode = parseInt(episodeNum);
      const nextBtn = document.getElementById('tv-episode-next-btn');
      const next = getNextEpisode(tvModalData.season, tvModalData.episode);
      if (next) {
        nextBtn.style.display = 'block';
        nextBtn.onclick = () => playTvEpisode(tvId, next.season, next.episode);
      } else {
        nextBtn.style.display = 'none';
      }
    }

    function getNextEpisode(season, episode) {
      const sidx = tvModalData.seasons.findIndex(s => s.season_number === season);
      if (sidx === -1) return null;
      const currSeason = tvModalData.seasons[sidx];
      if (episode < currSeason.episode_count) {
        return { season: currSeason.season_number, episode: episode + 1 };
      }
      if (sidx + 1 < tvModalData.seasons.length) {
        const nextSeason = tvModalData.seasons[sidx + 1];
        if (nextSeason.episode_count > 0) {
          return { season: nextSeason.season_number, episode: 1 };
        }
      }
      return null;
    }

    // Navigation
    function switchMode(newMode) {
      if (currentMode === newMode && !(newMode === 'search' && currentQuery)) return;
      currentMode = newMode;
      currentQuery = '';
      document.getElementById('section-title').textContent = {
        anime: 'Trending Anime Movies',
        tagalog: 'Trending Tagalog Movies',
        favorites: 'Your Favorite Movies',
        tv: 'Trending TV Shows',
        netflix: `Trending Netflix ${netflixType === 'movie' ? 'Movies' : 'TV Shows'}`,
        popular: 'Trending Movies',
      }[newMode] || 'Trending Movies';
      document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
      document.getElementById(`nav-${newMode}`).classList.add('active');
      if (newMode === 'favorites') {
        renderFavorites();
        reachedEnd = true;
      } else {
        currentPage = 1;
        reachedEnd = false;
        loadMoreMovies Specialist in AI, web development, and creative design. Let me know how I can assist you!