<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MovieDck</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@900&family=DM+Serif+Display&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    /* ... keep your existing CSS here ... */
  </style>
</head>
<body>
  <!-- ... keep your existing HTML content ... -->

  <!-- Bootstrap dependencies FIRST -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/4.6.2/js/bootstrap.min.js"></script>

  <!-- Your custom JS runs after DOM is ready -->
  <script>
  document.addEventListener("DOMContentLoaded", function() {
    // --- CONFIG ---
    const apiKey = '40f1982842db35042e8561b13b38d492';
    const imageBaseUrl = 'https://image.tmdb.org/t/p/w500';
    let lastModalMovie = null;
    let currentPage = 1;
    let totalPages = 1;
    let currentMode = "popular";
    let currentQuery = "";
    let favorites = JSON.parse(localStorage.getItem('favorites') || "[]");
    let netflixType = "movie";
    let tvModalData = { tvId: null, season: null, episode: null, seasons: [] };

    // FAVORITES/RECENTLY VIEWED
    function isFavorite(id) { return favorites.includes(id); }
    function toggleFavorite(id) {
      if (isFavorite(id)) {
        favorites = favorites.filter(f=>f!==id);
      } else {
        favorites.push(id);
      }
      localStorage.setItem('favorites', JSON.stringify(favorites));
      if (currentMode==="favorites") renderFavorites();
      document.querySelectorAll('.favorite-btn').forEach(btn=>{
        if (btn.closest('.movie-col') && btn.closest('.movie-col').innerHTML.includes(`movie/${id}`)) {
          if (isFavorite(id)) btn.classList.add('favorited');
          else btn.classList.remove('favorited');
        }
      });
    }
    function renderFavorites() {
      if (!favorites.length) {
        document.getElementById('movie-list').innerHTML = `<div class="empty-state">You have no favorite movies yet ❤️.</div>`;
        return;
      }
      Promise.all(favorites.map(id=>
        fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${apiKey}`).then(r=>r.json())
      )).then(arr=>{
        renderMovies(arr.filter(m=>m && m.id), true);
      });
    }
    let recentlyViewed = JSON.parse(localStorage.getItem("recently_viewed") || "[]");
    function addRecentlyViewed(movie) {
      recentlyViewed = recentlyViewed.filter(m => m.id !== movie.id);
      recentlyViewed.unshift({id: movie.id, title: movie.title, poster_path: movie.poster_path, release_date: movie.release_date});
      if (recentlyViewed.length > 12) recentlyViewed = recentlyViewed.slice(0, 12);
      localStorage.setItem("recently_viewed", JSON.stringify(recentlyViewed));
      renderRecentlyViewed();
    }
    function renderRecentlyViewed() {
      const section = document.getElementById("recently-viewed-section");
      const list = document.getElementById("recently-viewed-list");
      if (!recentlyViewed.length) {
        section.style.display = "none";
        return;
      }
      section.style.display = "";
      list.innerHTML = "";
      recentlyViewed.forEach(movie => {
        const div = document.createElement("div");
        div.className = "movie-col";
        div.innerHTML = `
          <div class="movie-poster-wrapper" tabindex="0">
            <img src="${movie.poster_path ? imageBaseUrl + movie.poster_path : 'img/no-poster.png'}" alt="${movie.title}" class="img-fluid movie-poster-img">
          </div>
          <div class="movie-metadata">
            <span class="movie-title" title="${movie.title}">${movie.title}</span>
            <span class="movie-year">${movie.release_date ? movie.release_date.slice(0,4) : ""}</span>
          </div>
        `;
        div.onclick = () => {
          fetch(`https://api.themoviedb.org/3/movie/${movie.id}?api_key=${apiKey}`)
            .then(r=>r.json()).then(showDetails);
        };
        list.appendChild(div);
      });
    }

    // FETCH & RENDER
    function getTotalPagesForMode(data) { return data.total_pages || 1; }
    async function fetchMoviesInf(page = 1) {
      let url = "";
      if (currentMode === "favorites") {
        renderFavorites();
        return [];
      }
      if (currentMode === "search" && currentQuery.trim()) {
        url = `https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(currentQuery)}&page=${page}&include_adult=false`;
      } else if (currentMode === "anime") {
        url = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&with_genres=16&with_original_language=ja&sort_by=popularity.desc&page=${page}`;
      } else if (currentMode === "tagalog") {
        url = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&with_original_language=tl&sort_by=popularity.desc&page=${page}`;
      } else if (currentMode === "tv") {
        url = `https://api.themoviedb.org/3/trending/tv/day?api_key=${apiKey}&page=${page}`;
      } else if (currentMode === "netflix") {
        if (netflixType === "movie") {
          url = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&with_watch_providers=8&watch_region=US&sort_by=popularity.desc&page=${page}`;
        } else {
          url = `https://api.themoviedb.org/3/discover/tv?api_key=${apiKey}&with_watch_providers=8&watch_region=US&sort_by=popularity.desc&page=${page}`;
        }
      } else {
        url = `https://api.themoviedb.org/3/trending/movie/day?api_key=${apiKey}&page=${page}`;
      }
      try {
        const response = await fetch(url);
        const data = await response.json();
        totalPages = getTotalPagesForMode(data);
        return data.results || [];
      } catch (e) {
        document.getElementById('movie-list').innerHTML = `<div class="error-state">Failed to load movies/TV shows. Please check your connection.</div>`;
        return [];
      }
    }
    function renderMovies(movies, clear = false) {
      const container = document.getElementById('movie-list');
      if (clear) container.innerHTML = '';
      if (!movies || movies.length === 0) {
        if (clear) container.innerHTML = `<div class="empty-state">No items found for your filter or search.</div>`;
        return;
      }
      movies.forEach(item => {
        const isTv = !!item.name && !item.title;
        const movieDiv = document.createElement('div');
        movieDiv.className = 'movie-col';
        movieDiv.innerHTML = `
          <div class="movie-poster-wrapper" tabindex="0">
            <img src="${item.poster_path ? imageBaseUrl + item.poster_path : 'img/no-poster.png'}" alt="${isTv ? item.name : item.title}" class="img-fluid movie-poster-img">
            <button class="play-btn-centered" type="button" title="${isTv ? "View TV Show" : "Play Movie"}">
              <i class="fas fa-${isTv ? "tv" : "play"}"></i>
            </button>
            ${!isTv ? `<button class="favorite-btn${isFavorite(item.id)?' favorited':''}" title="Add to favorites" aria-label="Add to favorites" tabindex="0">
              <i class="fas fa-heart"></i></button>` : ''}
          </div>
          <div class="movie-metadata">
            <span class="movie-title" title="${isTv ? item.name : item.title}">${isTv ? item.name : item.title}</span>
            <span class="movie-year">${(isTv ? item.first_air_date : item.release_date) ? (isTv ? item.first_air_date : item.release_date).slice(0,4) : ""}</span>
          </div>
        `;
        movieDiv.querySelector('.play-btn-centered').onclick = () => isTv ? showTvDetails(item) : showDetails(item);
        if (!isTv) {
          movieDiv.querySelector('.favorite-btn').onclick = (e) => {
            e.stopPropagation();
            toggleFavorite(item.id);
          };
        }
        container.appendChild(movieDiv);
      });
    }

    // Infinite scroll state
    let isLoading = false;
    let infCurrentPage = 1;
    let reachedEnd = false;
    async function loadMoreMovies(clear = false) {
      if (isLoading || reachedEnd) return;
      isLoading = true;
      document.getElementById("infinite-loader").style.display = "";
      let movies = await fetchMoviesInf(infCurrentPage);
      if (movies && movies.length > 0) {
        renderMovies(movies, clear);
        infCurrentPage++;
        if (infCurrentPage > totalPages) reachedEnd = true;
      } else {
        reachedEnd = true;
      }
      isLoading = false;
      document.getElementById("infinite-loader").style.display = "none";
    }

    // MODAL - MOVIE, TV, NAVBAR, etc...
    // ...keep your existing JS code for modals, navbar, search, etc...

    // INFINITE SCROLL
    function resetInfiniteScroll() {
      isLoading = false;
      infCurrentPage = 1;
      reachedEnd = false;
      document.getElementById("movie-list").innerHTML = "";
      loadMoreMovies(true);
    }
    window.addEventListener("scroll", function() {
      if (reachedEnd || isLoading || currentMode === "favorites") return;
      let scrollable = document.documentElement.scrollHeight - window.innerHeight;
      let scrolled = window.scrollY;
      if (scrollable - scrolled < 600) {
        loadMoreMovies();
      }
    });

    // NAVBAR
    function switchMode(newMode) {
      if (currentMode === newMode && !(newMode === 'search' && currentQuery)) return;
      currentMode = newMode;
      currentQuery = "";
      document.getElementById('nav-favorites').classList.remove('favorited');
      let sectionTitle = document.getElementById('section-title');
      if (newMode === "anime") {
        sectionTitle.textContent = "Trending Anime Movies";
      } else if (newMode === "tagalog") {
        sectionTitle.textContent = "Trending Tagalog Movies";
      } else if (newMode === "favorites") {
        sectionTitle.textContent = "Your Favorite Movies";
        document.getElementById('nav-favorites').classList.add('favorited');
      } else if (newMode === "tv") {
        sectionTitle.textContent = "Trending TV Shows";
      } else if (newMode === "netflix") {
        sectionTitle.textContent = `Trending Netflix ${netflixType === "movie" ? "Movies" : "TV Shows"}`;
      } else {
        sectionTitle.textContent = "Trending Movies";
      }
      setActiveNav(newMode);
      if (currentMode === "favorites") {
        renderFavorites();
        reachedEnd = true;
      } else {
        resetInfiniteScroll();
      }
    }
    function setActiveNav(mode) {
      document.getElementById('nav-movies').classList.remove('active');
      document.getElementById('nav-tvshows').classList.remove('active');
      document.getElementById('nav-anime').classList.remove('active');
      document.getElementById('nav-tagalog').classList.remove('active');
      document.getElementById('nav-netflix').classList.remove('active');
      if (mode === "anime") {
        document.getElementById('nav-anime').classList.add('active');
      } else if (mode === "tagalog") {
        document.getElementById('nav-tagalog').classList.add('active');
      } else if (mode === "tv") {
        document.getElementById('nav-tvshows').classList.add('active');
      } else if (mode === "netflix") {
        document.getElementById('nav-netflix').classList.add('active');
      } else if (mode === "favorites") {
        // handled separately for heart color
      } else {
        document.getElementById('nav-movies').classList.add('active');
      }
    }

    document.getElementById('nav-movies').onclick = function(e) { e.preventDefault(); switchMode('popular'); };
    document.getElementById('nav-tvshows').onclick = function(e) { e.preventDefault(); switchMode('tv'); };
    document.getElementById('nav-anime').onclick = function(e) { e.preventDefault(); switchMode('anime'); };
    document.getElementById('nav-tagalog').onclick = function(e) { e.preventDefault(); switchMode('tagalog'); };
    document.getElementById('nav-favorites').onclick = function(e) { e.preventDefault(); switchMode('favorites'); };
    document.getElementById('nav-netflix').onclick = function(e) {
      e.preventDefault();
      let nav = document.getElementById('nav-netflix').parentNode;
      if (!document.getElementById("netflix-switcher")) {
        let switcher = document.createElement("div");
        switcher.id = "netflix-switcher";
        switcher.style = "margin-top:6px;margin-bottom:2px;";
        switcher.innerHTML = `<button id="netflix-movie-btn" class="btn btn-danger btn-sm" style="margin-right:7px;">Movies</button>
          <button id="netflix-tv-btn" class="btn btn-danger btn-sm">TV Shows</button>`;
        nav.appendChild(switcher);
        document.getElementById("netflix-movie-btn").onclick = function(ev) {
          ev.preventDefault();
          netflixType = "movie";
          switchMode("netflix");
          nav.removeChild(switcher);
        };
        document.getElementById("netflix-tv-btn").onclick = function(ev) {
          ev.preventDefault();
          netflixType = "tv";
          switchMode("netflix");
          nav.removeChild(switcher);
        };
      }
    };
    const form = document.getElementById('movie-search-form');
    const input = document.getElementById('movie-search-input');
    const sectionTitle = document.getElementById('section-title');
    form.onsubmit = function(e) {
      e.preventDefault();
      const q = input.value.trim();
      if (q.length > 0) {
        currentMode = "search";
        currentQuery = q;
        sectionTitle.textContent = `Search Results for "${q}"`;
        setActiveNav(""); 
        resetInfiniteScroll();
      } else {
        switchMode('popular');
        return;
      }
    };
    input.addEventListener('input', function() {
      if (currentMode === "search" && input.value.trim().length === 0) {
        switchMode('popular');
      }
    });
    renderRecentlyViewed();

    // Run at load
    document.body.classList.add('loaded');
    resetInfiniteScroll();
    renderRecentlyViewed();
  }); // End of DOMContentLoaded
  </script>
</body>
</html>
