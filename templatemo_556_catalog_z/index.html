<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MovieDck - Stream Movies & TV</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #0f1218;
      color: #e5e7eb;
    }
    h1, h2, h3 {
      font-family: 'Playfair Display', serif;
    }
    .navbar {
      background: rgba(15, 18, 24, 0.95) !important;
      backdrop-filter: blur(10px);
    }
    .navbar-brand {
      font-size: 1.8rem;
      color: #fff !important;
    }
    .nav-link {
      color: #e5e7eb !important;
    }
    .nav-link:hover, .nav-link.active {
      color: #3b82f6 !important;
    }
    .poster-card {
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .poster-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
    }
    .poster-img {
      border-radius: 8px;
      opacity: 0.7;
      transition: opacity 0.3s;
    }
    .poster-img.loaded {
      opacity: 1;
    }
    .modal-content {
      background: #1a1f25;
      border: none;
      border-radius: 12px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .iframe-spinner {
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 10;
    }
    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .chip {
      background: #3b82f6;
      color: #fff;
      padding: 0.3rem 0.8rem;
      border-radius: 12px;
      font-size: 0.9rem;
    }
    .search-form {
      max-width: 600px;
      margin: 2rem auto;
    }
    .recently-viewed {
      background: #1a1f25;
      padding: 1rem;
      border-radius: 12px;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">MovieDck</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars text-white"></i>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link active" id="nav-movies" href="#">Movies</a></li>
          <li class="nav-item"><a class="nav-link" id="nav-tvshows" href="#">TV Shows</a></li>
          <li class="nav-item"><a class="nav-link" id="nav-anime" href="#">Anime</a></li>
          <li class="nav-item"><a class="nav-link" id="nav-tagalog" href="#">Tagalog</a></li>
          <li class="nav-item"><a class="nav-link" id="nav-netflix" href="#">Netflix</a></li>
          <li class="nav-item"><a class="nav-link" id="nav-favorites" href="#"><i class="fas fa-heart"></i> Favorites</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Search -->
  <div class="container">
    <form class="search-form" id="movie-search-form">
      <div class="input-group">
        <input type="search" id="movie-search-input" class="form-control bg-dark text-white border-dark" placeholder="Search movies or TV shows..." aria-label="Search">
        <button class="btn btn-primary" type="submit" aria-label="Search"><i class="fas fa-search"></i></button>
      </div>
    </form>
  </div>

  <!-- Recently Viewed -->
  <div class="container recently-viewed mb-4" id="recently-viewed-section" style="display:none;">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="text-white">Recently Viewed</h3>
      <button class="btn btn-link text-primary" id="clear-recent-btn" style="display:none;">Clear</button>
    </div>
    <div class="d-flex gap-3 overflow-x-auto pb-3" id="recently-viewed-list"></div>
  </div>

  <!-- Content -->
  <div class="container">
    <h2 class="text-white mb-4" id="section-title">Trending Movies</h2>
    <div class="row g-3" id="movie-list"></div>
    <div class="text-center mt-4"><div class="iframe-spinner" id="infinite-loader" style="display:none;"></div></div>
  </div>

  <!-- Modal -->
  <div class="modal fade" id="modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <!-- Movie Modal -->
        <div id="modal-content-movie">
          <div class="modal-header border-0">
            <h5 class="modal-title text-white" id="modal-title"></h5>
            <button type="button" class="btn-close btn-close-white" onclick="closeModal()" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-4">
                <img id="modal-image" class="img-fluid rounded" src="" alt="Poster">
              </div>
              <div class="col-md-8">
                <div id="modal-rating" class="mb-2"></div>
                <div id="modal-genres" class="mb-2"></div>
                <p id="modal-description"></p>
                <p id="modal-cast"></p>
                <p id="modal-crew"></p>
                <a id="modal-trailer" class="text-primary" target="_blank"></a>
                <button class="btn btn-primary mt-3" onclick="shareMovie()" aria-label="Share movie">Share</button>
              </div>
            </div>
            <div class="mt-3">
              <label for="server" class="text-white me-2">Server:</label>
              <select id="server" onchange="changeServer()" class="form-select bg-dark text-white d-inline w-auto" aria-label="Select server">
                <option value="vidsrc.me">VidSrc.me</option>
                <option value="vidsrc.cc">VidSrc.cc</option>
              </select>
            </div>
            <div class="position-relative mt-3">
              <iframe id="modal-video" class="w-100" style="aspect-ratio:16/9;" allowfullscreen></iframe>
              <div class="iframe-spinner" style="display:none;"></div>
            </div>
          </div>
        </div>
        <!-- TV Modal -->
        <div id="modal-content-tv" style="display:none;">
          <div class="modal-header border-0">
            <h5 class="modal-title text-white" id="tv-modal-title"></h5>
            <button type="button" class="btn-close btn-close-white" onclick="closeModal()" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-4">
                <img id="tv-modal-image" class="img-fluid rounded" src="" alt="Poster">
              </div>
              <div class="col-md-8">
                <div id="tv-modal-genres" class="mb-2"></div>
                <p id="tv-modal-description"></p>
                <p><strong>First Air:</strong> <span id="tv-modal-air-date"></span></p>
                <p><strong>Seasons:</strong> <span id="tv-modal-total-seasons"></span></p>
                <button class="btn btn-primary mt-3" onclick="shareTvShow()" aria-label="Share TV show">Share</button>
                <div id="tv-modal-seasons-list" class="mt-3"></div>
              </div>
            </div>
            <div class="position-relative mt-3">
              <iframe id="tv-episode-player" class="w-100" style="aspect-ratio:16/9;display:none;" allowfullscreen></iframe>
              <div class="iframe-spinner" style="display:none;"></div>
            </div>
            <div class="text-center mt-3">
              <button class="btn btn-primary" id="tv-episode-next-btn" style="display:none;" aria-label="Next episode">Next Episode</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const apiKey = '40f1982842db35042e8561b13b38d492';
    const imageBaseUrl = 'https://image.tmdb.org/t/p/';
    let lastModalMovie = null;
    let currentPage = 1;
    let totalPages = 1;
    let currentMode = 'popular';
    let currentQuery = '';
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    let netflixType = 'movie';
    let tvModalData = { tvId: null, season: null, episode: null, seasons: [] };

    // Error Handling
    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'alert alert-danger alert-dismissible fade show';
      errorDiv.innerHTML = `${message} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
      document.body.prepend(errorDiv);
      setTimeout(() => errorDiv.remove(), 5000);
    }

    // Progressive Image Loading
    function loadProgressiveImage(img, highResSrc) {
      img.src = highResSrc.replace('/w500', '/w92');
      img.classList.add('poster-img');
      const highRes = new Image();
      highRes.src = highResSrc;
      highRes.onload = () => {
        img.src = highResSrc;
        img.classList.add('loaded');
      };
    }

    // Favorites & Recently Viewed
    function isFavorite(id) { return favorites.includes(id); }
    function toggleFavorite(id) {
      favorites = isFavorite(id) ? favorites.filter(f => f !== id) : [...favorites, id];
      localStorage.setItem('favorites', JSON.stringify(favorites));
      if (currentMode === 'favorites') renderFavorites();
      document.querySelectorAll('.favorite-btn').forEach(btn => {
        if (btn.dataset.id == id) btn.classList.toggle('text-danger', isFavorite(id));
      });
    }
    let recentlyViewed = JSON.parse(localStorage.getItem('recently_viewed') || '[]');
    function addRecentlyViewed(item) {
      const isTv = !!item.name && !item.title;
      recentlyViewed = recentlyViewed.filter(m => m.id !== item.id || m.isTv !== isTv);
      recentlyViewed.unshift({
        id: item.id,
        title: isTv ? item.name : item.title,
        poster_path: item.poster_path,
        release_date: isTv ? item.first_air_date : item.release_date,
        isTv,
        timestamp: Date.now()
      });
      if (recentlyViewed.length > 12) recentlyViewed = recentlyViewed.slice(0, 12);
      localStorage.setItem('recently_viewed', JSON.stringify(recentlyViewed));
      renderRecentlyViewed();
    }
    function clearRecentlyViewed() {
      recentlyViewed = [];
      localStorage.setItem('recently_viewed', '[]');
      renderRecentlyViewed();
    }
    function renderRecentlyViewed() {
      const section = document.getElementById('recently-viewed-section');
      const list = document.getElementById('recently-viewed-list');
      const clearBtn = document.getElementById('clear-recent-btn');
      if (!recentlyViewed.length) {
        section.style.display = 'none';
        clearBtn.style.display = 'none';
        return;
      }
      section.style.display = 'block';
      clearBtn.style.display = 'block';
      list.innerHTML = '';
      recentlyViewed.sort((a, b) => b.timestamp - a.timestamp).forEach(item => {
        const div = document.createElement('div');
        div.className = 'flex-shrink-0';
        div.style.width = '120px';
        div.innerHTML = `
          <div class="poster-card cursor-pointer">
            <img src="${item.poster_path ? imageBaseUrl + 'w92' + item.poster_path : 'img/no-poster.png'}" alt="${item.title}" class="img-fluid poster-img rounded">
            <p class="text-white text-sm mt-1 text-truncate">${item.title}</p>
          </div>
        `;
        const img = div.querySelector('img');
        if (item.poster_path) loadProgressiveImage(img, imageBaseUrl + 'w500' + item.poster_path);
        div.onclick = () => fetch(`https://api.themoviedb.org/3/${item.isTv ? 'tv' : 'movie'}/${item.id}?api_key=${apiKey}`)
          .then(r => r.json()).then(data => item.isTv ? showTvDetails(data) : showDetails(data));
        list.appendChild(div);
      });
    }

    // Fetch Movies
    async function fetchMoviesInf(page = 1) {
      if (!navigator.onLine) {
        showError('You are offline. Please check your connection.');
        return [];
      }
      let url = '';
      if (currentMode === 'favorites') {
        renderFavorites();
        return [];
      }
      if (currentMode === 'search' && currentQuery.trim()) {
        url = `https://api.themoviedb.org/3/search/movie?api_key=${apiKey}&query=${encodeURIComponent(currentQuery)}&page=${page}&include_adult=false`;
      } else if (currentMode === 'anime') {
        url = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&with_genres=16&with_original_language=ja&sort_by=popularity.desc&page=${page}`;
      } else if (currentMode === 'tagalog') {
        url = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&with_original_language=tl&sort_by=popularity.desc&page=${page}`;
      } else if (currentMode === 'tv') {
        url = `https://api.themoviedb.org/3/trending/tv/day?api_key=${apiKey}&page=${page}`;
      } else if (currentMode === 'netflix') {
        url = `https://api.themoviedb.org/3/discover/${netflixType}?api_key=${apiKey}&with_watch_providers=8&watch_region=US&sort_by=popularity.desc&page=${page}`;
      } else {
        url = `https://api.themoviedb.org/3/trending/movie/day?api_key=${apiKey}&page=${page}`;
      }
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('API request failed');
        const data = await response.json();
        totalPages = data.total_pages || 1;
        return data.results || [];
      } catch (e) {
        showError('Failed to load content. Please try again.');
        return [];
      }
    }

    // Render Movies
    function renderMovies(movies, clear = false) {
      const container = document.getElementById('movie-list');
      if (clear) container.innerHTML = '';
      if (!movies.length) {
        container.innerHTML = '<div class="col-12 text-center text-gray-400">No items found.</div>';
        return;
      }
      movies.forEach(item => {
        const isTv = !!item.name && !item.title;
        const div = document.createElement('div');
        div.className = 'col-6 col-sm-4 col-md-3 col-lg-2';
        div.innerHTML = `
          <div class="poster-card position-relative">
            <img src="${item.poster_path ? imageBaseUrl + 'w92' + item.poster_path : 'img/no-poster.png'}" alt="${isTv ? item.name : item.title}" class="img-fluid poster-img">
            ${!isTv ? `<button class="favorite-btn position-absolute top-0 end-0 m-2 ${isFavorite(item.id) ? 'text-danger' : 'text-white'}" data-id="${item.id}" aria-label="Toggle favorite"><i class="fas fa-heart"></i></button>` : ''}
            <button class="play-btn position-absolute top-50 start-50 translate-middle bg-primary bg-opacity-75 rounded-circle p-2" aria-label="${isTv ? 'View TV Show' : 'Play Movie'}">
              <i class="fas fa-${isTv ? 'tv' : 'play'} text-white"></i>
            </button>
            <div class="mt-2">
              <p class="text-white text-sm text-truncate">${isTv ? item.name : item.title}</p>
              <p class="text-gray-400 text-xs">${(isTv ? item.first_air_date : item.release_date)?.slice(0, 4) || ''}</p>
            </div>
          </div>
        `;
        const img = div.querySelector('img');
        if (item.poster_path) loadProgressiveImage(img, imageBaseUrl + 'w500' + item.poster_path);
        div.querySelector('.play-btn').onclick = () => isTv ? showTvDetails(item) : showDetails(item);
        if (!isTv) div.querySelector('.favorite-btn').onclick = (e) => {
          e.stopPropagation();
          toggleFavorite(item.id);
        };
        container.appendChild(div);
      });
    }

    // Infinite Scroll
    let isLoading = false;
    let reachedEnd = false;
    async function loadMoreMovies(clear = false) {
      if (isLoading || reachedEnd) return;
      isLoading = true;
      document.getElementById('infinite-loader').style.display = 'block';
      const movies = await fetchMoviesInf(currentPage);
      if (movies.length) {
        renderMovies(movies, clear);
        currentPage++;
        if (currentPage > totalPages) reachedEnd = true;
      } else {
        reachedEnd = true;
      }
      isLoading = false;
      document.getElementById('infinite-loader').style.display = 'none';
    }

    // Movie Modal
    async function showDetails(movie) {
      lastModalMovie = movie;
      addRecentlyViewed(movie);
      document.getElementById('modal-content-movie').style.display = 'block';
      document.getElementById('modal-content-tv').style.display = 'none';
      document.getElementById('modal-title').textContent = movie.title;
      document.getElementById('modal-description').textContent = movie.overview || 'No description available.';
      const modalImg = document.getElementById('modal-image');
      if (movie.poster_path) loadProgressiveImage(modalImg, imageBaseUrl + 'w500' + movie.poster_path);
      else modalImg.src = 'img/no-poster.png';
      document.getElementById('modal-rating').innerHTML = `${getStars(movie.vote_average || 0)} (${movie.vote_average || 'N/A'})`;
      document.getElementById('modal-genres').innerHTML = (movie.genres || []).map(g => `<span class="chip me-1">${g.name}</span>`).join('');
      document.getElementById('modal-cast').textContent = 'Loading cast...';
      document.getElementById('modal-crew').textContent = '';
      document.getElementById('modal-trailer').innerHTML = '';
      fetch(`https://api.themoviedb.org/3/movie/${movie.id}/credits?api_key=${apiKey}`)
        .then(r => r.json())
        .then(data => {
          const cast = (data.cast || []).slice(0, 5).map(c => c.name).join(', ');
          const director = (data.crew || []).find(c => c.job === 'Director');
          document.getElementById('modal-cast').innerHTML = cast ? `<strong>Cast:</strong> ${cast}` : '';
          document.getElementById('modal-crew').innerHTML = director ? `<strong>Director:</strong> ${director.name}` : '';
        })
        .catch(() => showError('Failed to load credits.'));
      fetch(`https://api.themoviedb.org/3/movie/${movie.id}/videos?api_key=${apiKey}`)
        .then(r => r.json())
        .then(data => {
          const yt = (data.results || []).find(v => v.site === 'YouTube' && v.type === 'Trailer');
          if (yt) {
            document.getElementById('modal-trailer').innerHTML = 'Watch Trailer';
            document.getElementById('modal-trailer').href = `https://youtube.com/watch?v=${yt.key}`;
          }
        });
      document.getElementById('server').value = 'vidsrc.me';
      changeServer();
      new bootstrap.Modal(document.getElementById('modal')).show();
    }

    function getStars(vote) {
      const stars = Math.round((vote || 0) / 2);
      return '★'.repeat(stars) + '☆'.repeat(5 - stars);
    }

    function changeServer() {
      if (!lastModalMovie) return;
      const server = document.getElementById('server').value;
      const iframe = document.getElementById(lastModalMovie.media_type === 'tv' ? 'tv-episode-player' : 'modal-video');
      const spinner = iframe.nextElementSibling;
      let embedURL = '';
      if (server === 'vidsrc.me') {
        embedURL = `https://vidsrc.me/embed/${lastModalMovie.media_type === 'tv' ? `tv?tmdb=${lastModalMovie.id}&season=${tvModalData.season}&episode=${tvModalData.episode}` : `movie/${lastModalMovie.id}`}?autoplay=1`;
      } else {
        embedURL = `https://vidsrc.cc/api/embed/${lastModalMovie.media_type === 'tv' ? `tv/${lastModalMovie.id}/${tvModalData.season}/${tvModalData.episode}` : `movie/${lastModalMovie.id}`}?autoplay=1`;
      }
      spinner.style.display = 'block';
      iframe.src = embedURL;
      iframe.onload = () => spinner.style.display = 'none';
      iframe.onerror = () => {
        spinner.style.display = 'none';
        if (server === 'vidsrc.me') {
          document.getElementById('server').value = 'vidsrc.cc';
          changeServer();
          showError('Primary server failed. Switched to backup.');
        } else {
          showError('Video failed to load. Try again later.');
        }
      };
    }

    function closeModal() {
      const modal = bootstrap.Modal.getInstance(document.getElementById('modal'));
      modal.hide();
      document.getElementById('modal-video').src = '';
      document.getElementById('tv-episode-player').style.display = 'none';
      document.getElementById('tv-episode-player').src = '';
      document.getElementById('tv-episode-next-btn').style.display = 'none';
    }

    // TV Modal
    async function showTvDetails(tv) {
      lastModalMovie = { id: tv.id, media_type: 'tv' };
      document.getElementById('modal-content-movie').style.display = 'none';
      document.getElementById('modal-content-tv').style.display = 'block';
      document.getElementById('tv-modal-title').textContent = tv.name;
      const modalImg = document.getElementById('tv-modal-image');
      if (tv.poster_path) loadProgressiveImage(modalImg, imageBaseUrl + 'w500' + tv.poster_path);
      else modalImg.src = 'img/no-poster.png';
      document.getElementById('tv-modal-description').textContent = tv.overview || '';
      document.getElementById('tv-modal-air-date').textContent = tv.first_air_date || '';
      document.getElementById('tv-modal-total-seasons').textContent = tv.number_of_seasons;
      document.getElementById('tv-modal-genres').innerHTML = (tv.genres || []).map(g => `<span class="chip me-1">${g.name}</span>`).join('');
      document.getElementById('tv-modal-seasons-list').innerHTML = '';
      addRecentlyViewed(tv);
      const tvInfo = await fetch(`https://api.themoviedb.org/3/tv/${tv.id}?api_key=${apiKey}`).then(r => r.json());
      tvModalData.tvId = tvInfo.id;
      tvModalData.seasons = tvInfo.seasons;
      tvInfo.seasons.forEach(season => {
        const div = document.createElement('div');
        div.className = 'mb-3';
        div.innerHTML = `
          <h4 class="text-white cursor-pointer" tabindex="0" aria-label="Toggle ${season.name}">${season.name} (${season.episode_count} eps)</h4>
          <div class="episodes-list d-none"></div>
        `;
        const header = div.querySelector('h4');
        header.onclick = async () => {
          const epList = div.querySelector('.episodes-list');
          epList.classList.toggle('d-none');
          if (!epList.innerHTML) {
            const data = await fetch(`https://api.themoviedb.org/3/tv/${tv.id}/season/${season.season_number}?api_key=${apiKey}`).then(r => r.json());
            epList.innerHTML = (data.episodes || []).map(ep => `
              <div class="d-flex justify-content-between align-items-center py-1">
                <span>Ep ${ep.episode_number}: ${ep.name || '(Untitled)'}</span>
                <button class="btn btn-primary btn-sm" onclick="playTvEpisode('${tv.id}', '${season.season_number}', '${ep.episode_number}')" aria-label="Play episode">Play</button>
              </div>
            `).join('');
          }
        };
        header.onkeydown = e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            header.click();
          }
        };
        document.getElementById('tv-modal-seasons-list').appendChild(div);
      });
      new bootstrap.Modal(document.getElementById('modal')).show();
    }

    function playTvEpisode(tvId, seasonNum, episodeNum) {
      const iframe = document.getElementById('tv-episode-player');
      const spinner = iframe.nextElementSibling;
      iframe.style.display = 'block';
      tvModalData.season = parseInt(seasonNum);
      tvModalData.episode = parseInt(episodeNum);
      changeServer();
      const nextBtn = document.getElementById('tv-episode-next-btn');
      const next = getNextEpisode(tvModalData.season, tvModalData.episode);
      if (next) {
        nextBtn.style.display = 'block';
        nextBtn.onclick = () => playTvEpisode(tvId, next.season, next.episode);
      } else {
        nextBtn.style.display = 'none';
      }
    }

    function getNextEpisode(season, episode) {
      const sidx = tvModalData.seasons.findIndex(s => s.season_number === season);
      if (sidx === -1) return null;
      const currSeason = tvModalData.seasons[sidx];
      if (episode < currSeason.episode_count) {
        return { season: currSeason.season_number, episode: episode + 1 };
      }
      if (sidx + 1 < tvModalData.seasons.length) {
        const nextSeason = tvModalData.seasons[sidx + 1];
        if (nextSeason.episode_count > 0) {
          return { season: nextSeason.season_number, episode: 1 };
        }
      }
      return null;
    }

    // Navigation
    function switchMode(newMode) {
      if (currentMode === newMode && !(newMode === 'search' && currentQuery)) return;
      currentMode = newMode;
      currentQuery = '';
      document.getElementById('section-title').textContent = {
        anime: 'Trending Anime Movies',
        tagalog: 'Trending Tagalog Movies',
        favorites: 'Your Favorite Movies',
        tv: 'Trending TV Shows',
        netflix: `Trending Netflix ${netflixType === 'movie' ? 'Movies' : 'TV Shows'}`,
        popular: 'Trending Movies'
      }[newMode] || 'Trending Movies';
      document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
      document.getElementById(`nav-${newMode}`).classList.add('active');
      if (newMode === 'favorites') {
        renderFavorites();
        reachedEnd = true;
      } else {
        currentPage = 1;
        reachedEnd = false;
        loadMoreMovies(true);
      }
    }

    function renderFavorites() {
      if (!favorites.length) {
        document.getElementById('movie-list').innerHTML = '<div class="col-12 text-center text-gray-400">No favorites yet.</div>';
        return;
      }
      Promise.all(favorites.map(id =>
        fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${apiKey}`).then(r => r.json())
      )).then(arr => renderMovies(arr.filter(m => m && m.id), true));
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('nav-movies').onclick = e => { e.preventDefault(); switchMode('popular'); };
      document.getElementById('nav-tvshows').onclick = e => { e.preventDefault(); switchMode('tv'); };
      document.getElementById('nav-anime').onclick = e => { e.preventDefault(); switchMode('anime'); };
      document.getElementById('nav-tagalog').onclick = e => { e.preventDefault(); switchMode('tagalog'); };
      document.getElementById('nav-favorites').onclick = e => { e.preventDefault(); switchMode('favorites'); };
      document.getElementById('nav-netflix').onclick = e => {
        e.preventDefault();
        switchMode('netflix');
      };
      document.getElementById('movie-search-form').onsubmit = e => {
        e.preventDefault();
        const q = document.getElementById('movie-search-input').value.trim();
        if (q) {
          currentMode = 'search';
          currentQuery = q;
          document.getElementById('section-title').textContent = `Search Results for "${q}"`;
          document.querySelectorAll('.nav-link').forEach(a => a.classList.remove('active'));
          currentPage = 1;
          reachedEnd = false;
          loadMoreMovies(true);
        }
      };
      document.getElementById('clear-recent-btn').onclick = clearRecentlyViewed;
      window.addEventListener('scroll', () => {
        if (reachedEnd || isLoading || currentMode === 'favorites') return;
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
          loadMoreMovies();
        }
      });
      renderRecentlyViewed();
      loadMoreMovies(true);
    });

    function shareMovie() {
      if (!lastModalMovie) return;
      const url = `${location.origin}${location.pathname}?mid=${lastModalMovie.id}`;
      if (navigator.share) {
        navigator.share({ title: lastModalMovie.title, text: 'Check out this movie on MovieDck!', url });
      } else {
        navigator.clipboard.writeText(url);
        showError('Link copied to clipboard!');
      }
    }

    function shareTvShow() {
      const title = document.getElementById('tv-modal-title').textContent;
      if (!title) return;
      const url = location.href.split('?')[0];
      if (navigator.share) {
        navigator.share({ title, text: 'Check out this TV show on MovieDck!', url });
      } else {
        navigator.clipboard.writeText(url);
        showError('Link copied to clipboard!');
      }
    }
  </script>
</body>
</html>