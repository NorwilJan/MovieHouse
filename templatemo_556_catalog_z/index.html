<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MovieDck - Ultimate Streaming Hub</title>
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(180deg, #0f1218 0%, #1a1f25 100%);
      color: #e5e7eb;
    }
    h1, h2, h3 {
      font-family: 'Playfair Display', serif;
    }
    .glass {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .poster-img {
      border-radius: 8px;
      opacity: 0.7;
      transition: opacity 0.3s, transform 0.3s;
    }
    .poster-img.loaded {
      opacity: 1;
    }
    .poster-card:hover .poster-img {
      transform: scale(1.05);
      opacity: 1;
    }
    .carousel-item {
      transition: opacity 0.5s ease;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(10, 12, 16, 0.95);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      max-width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      border-radius: 12px;
    }
    .iframe-spinner {
      border: 4px solid rgba(255, 255, 255, 0.2);
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 0.8s linear infinite;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }
    .chip {
      background: #3b82f6;
      color: #fff;
      padding: 0.3rem 0.8rem;
      border-radius: 12px;
      font-size: 0.9rem;
    }
    .search-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(10, 12, 16, 0.95);
      z-index: 1001;
      align-items: center;
      justify-content: center;
    }
    .search-results {
      max-height: 60vh;
      overflow-y: auto;
    }
    .navbar {
      transition: background 0.3s;
    }
    .navbar.scrolled {
      background: rgba(15, 18, 24, 0.95) !important;
    }
    @media (max-width: 768px) {
      .modal-content {
        max-width: 95%;
      }
      .poster-card {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar fixed top-0 w-full glass z-20 py-4">
    <div class="container mx-auto flex items-center justify-between px-4">
      <h1 class="text-2xl text-white">MovieDck</h1>
      <div class="flex items-center gap-4">
        <div class="hidden md:flex gap-4">
          <a href="#" class="text-white hover:text-blue-400 active" id="nav-movies">Movies</a>
          <a href="#" class="text-white hover:text-blue-400" id="nav-tvshows">TV Shows</a>
          <a href="#" class="text-white hover:text-blue-400" id="nav-anime">Anime</a>
          <a href="#" class="text-white hover:text-blue-400" id="nav-tagalog">Tagalog</a>
          <a href="#" class="text-white hover:text-blue-400" id="nav-netflix">Netflix</a>
          <a href="#" class="text-white hover:text-blue-400" id="nav-favorites"><i class="fas fa-heart mr-1"></i>Favorites</a>
        </div>
        <input type="text" class="bg-gray-800 text-white p-2 rounded-lg border-none focus:ring-2 focus:ring-blue-600" placeholder="Search..." onfocus="openSearchModal()" aria-label="Search">
        <button class="md:hidden text-white" id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
      </div>
    </div>
    <!-- Mobile Menu -->
    <div class="hidden md:hidden bg-gray-900 glass p-4" id="mobile-menu">
      <a href="#" class="block py-2 text-white hover:text-blue-400" id="nav-mobile-movies">Movies</a>
      <a href="#" class="block py-2 text-white hover:text-blue-400" id="nav-mobile-tvshows">TV Shows</a>
      <a href="#" class="block py-2 text-white hover:text-blue-400" id="nav-mobile-anime">Anime</a>
      <a href="#" class="block py-2 text-white hover:text-blue-400" id="nav-mobile-tagalog">Tagalog</a>
      <a href="#" class="block py-2 text-white hover:text-blue-400" id="nav-mobile-netflix">Netflix</a>
      <a href="#" class="block py-2 text-white hover:text-blue-400" id="nav-mobile-favorites"><i class="fas fa-heart mr-1"></i>Favorites</a>
    </div>
  </nav>

  <!-- Hero Carousel -->
  <div class="relative h-96 mb-8" id="hero-carousel">
    <div class="absolute inset-0 carousel-item opacity-0" id="carousel-item-1">
      <img class="w-full h-full object-cover opacity-50" src="" alt="Featured">
      <div class="absolute inset-0 flex items-center justify-center">
        <div class="text-center text-white">
          <h2 class="text-3xl mb-2"></h2>
          <button class="bg-blue-600 text-white px-4 py-2 rounded" onclick="playFeatured(1)">Watch Now</button>
        </div>
      </div>
    </div>
    <div class="absolute inset-0 carousel-item opacity-0" id="carousel-item-2">
      <img class="w-full h-full object-cover opacity-50" src="" alt="Featured">
      <div class="absolute inset-0 flex items-center justify-center">
        <div class="text-center text-white">
          <h2 class="text-3xl mb-2"></h2>
          <button class="bg-blue-600 text-white px-4 py-2 rounded" onclick="playFeatured(2)">Watch Now</button>
        </div>
      </div>
    </div>
    <div class="absolute inset-0 carousel-item opacity-0" id="carousel-item-3">
      <img class="w-full h-full object-cover opacity-50" src="" alt="Featured">
      <div class="absolute inset-0 flex items-center justify-center">
        <div class="text-center text-white">
          <h2 class="text-3xl mb-2"></h2>
          <button class="bg-blue-600 text-white px-4 py-2 rounded" onclick="playFeatured(3)">Watch Now</button>
        </div>
      </div>
    </div>
    <div class="iframe-spinner" id="carousel-spinner"></div>
  </div>

  <!-- Main Content -->
  <div class="container mx-auto px-4">
    <!-- Recently Viewed -->
    <div class="mb-8" id="recently-viewed-section" style="display:none;">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-2xl text-white">Recently Viewed</h2>
        <button class="text-blue-400 hover:text-blue-300" id="clear-recent-btn">Clear</button>
      </div>
      <div class="flex gap-4 overflow-x-auto pb-4" id="recently-viewed-list"></div>
    </div>

    <!-- Trending Movies -->
    <div class="mb-8">
      <h2 class="text-2xl text-white mb-4">Trending Movies</h2>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="movies-list"></div>
    </div>

    <!-- Trending TV Shows -->
    <div class="mb-8">
      <h2 class="text-2xl text-white mb-4">Trending TV Shows</h2>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="tvshows-list"></div>
    </div>

    <!-- Trending Anime -->
    <div class="mb-8">
      <h2 class="text-2xl text-white mb-4">Trending Anime</h2>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="anime-list"></div>
    </div>

    <!-- Trending Tagalog -->
    <div class="mb-8">
      <h2 class="text-2xl text-white mb-4">Trending Tagalog</h2>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="tagalog-list"></div>
    </div>

    <!-- Trending Netflix -->
    <div class="mb-8">
      <h2 class="text-2xl text-white mb-4">Trending Netflix</h2>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="netflix-list"></div>
    </div>

    <!-- Favorites -->
    <div class="mb-8" id="favorites-section" style="display:none;">
      <h2 class="text-2xl text-white mb-4">Your Favorites</h2>
      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4" id="favorites-list"></div>
    </div>

    <div class="iframe-spinner my-8 mx-auto" id="infinite-loader" style="display:none;"></div>
  </div>

  <!-- Movie/TV Modal -->
  <div class="modal" id="modal">
    <div class="modal-content glass p-6">
      <button class="absolute top-4 right-4 text-red-500 text-2xl" onclick="closeModal()" aria-label="Close modal">&times;</button>
      <!-- Movie Modal -->
      <div id="modal-content-movie">
        <div class="flex flex-col md:flex-row gap-6">
          <img id="modal-image" class="w-48 rounded-lg" src="" alt="Poster">
          <div class="flex-1">
            <h2 id="modal-title" class="text-3xl text-white mb-2"></h2>
            <div class="flex items-center mb-2" id="modal-rating"></div>
            <div class="flex gap-2 mb-2" id="modal-genres"></div>
            <p id="modal-description" class="text-gray-300"></p>
            <p id="modal-cast" class="text-gray-300"></p>
            <p id="modal-crew" class="text-gray-300"></p>
            <a id="modal-trailer" class="text-blue-400 hover:text-blue-300" target="_blank"></a>
            <button class="mt-4 bg-blue-600 text-white px-4 py-2 rounded" onclick="shareMovie()" aria-label="Share movie">Share</button>
          </div>
        </div>
        <div class="mt-4">
          <label for="server" class="text-white mr-2">Server:</label>
          <select id="server" onchange="changeServer()" class="bg-gray-800 text-white p-2 rounded" aria-label="Select video server">
            <option value="vidsrc.to">VidSrc.to</option>
            <option value="vidsrc.me">VidSrc.me</option>
            <option value="vidsrc.cc">VidSrc.cc</option>
          </select>
        </div>
        <div class="mt-4 relative">
          <iframe id="modal-video" class="w-full" style="aspect-ratio:16/9;" frameborder="0" allowfullscreen></iframe>
          <div class="iframe-spinner" style="display:none;" id="video-spinner"></div>
        </div>
      </div>
      <!-- TV Modal -->
      <div id="modal-content-tv" style="display:none;">
        <div class="flex flex-col md:flex-row gap-6">
          <img id="tv-modal-image" class="w-48 rounded-lg" src="" alt="Poster">
          <div class="flex-1">
            <h2 id="tv-modal-title" class="text-3xl text-white mb-2"></h2>
            <div class="flex gap-2 mb-2" id="tv-modal-genres"></div>
            <p id="tv-modal-description" class="text-gray-300"></p>
            <p><strong>First Air:</strong> <span id="tv-modal-air-date"></span></p>
            <p><strong>Seasons:</strong> <span id="tv-modal-total-seasons"></span></p>
            <button class="mt-4 bg-blue-600 text-white px-4 py-2 rounded" onclick="shareTvShow()" aria-label="Share TV show">Share</button>
            <div id="tv-modal-seasons-list" class="mt-4 max-h-64 overflow-y-auto"></div>
          </div>
        </div>
        <div class="mt-4 relative">
          <iframe id="tv-episode-player" class="w-full" style="aspect-ratio:16/9;display:none;" frameborder="0" allowfullscreen></iframe>
          <div class="iframe-spinner" style="display:none;" id="tv-video-spinner"></div>
        </div>
        <button class="mt-4 bg-blue-600 text-white px-4 py-2 rounded" id="tv-episode-next-btn" style="display:none;" aria-label="Next episode">Next Episode</button>
      </div>
    </div>
  </div>

  <!-- Search Modal -->
  <div class="search-modal" id="search-modal">
    <div class="glass p-6 w-full max-w-2xl">
      <button class="absolute top-4 right-4 text-red-500 text-2xl" onclick="closeSearchModal()" aria-label="Close search modal">&times;</button>
      <input type="text" id="search-input" class="w-full p-3 rounded-lg bg-gray-800 text-white border-none focus:ring-2 focus:ring-blue-600" placeholder="Search for a movie or show..." oninput="searchTMDB()" aria-label="Search">
      <div class="search-results mt-4" id="search-results"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-gray-900 py-6 mt-12">
    <div class="container mx-auto px-4 text-center">
      <p class="text-gray-400">© 2025 MovieDck. All rights reserved.</p>
      <div class="flex justify-center gap-4 mt-2">
        <a href="#" class="text-blue-400 hover:text-blue-300">Disclaimer</a>
        <a href="#" class="text-blue-400 hover:text-blue-300">About Us</a>
        <a href="#" class="text-blue-400 hover:text-blue-300">Contact Us</a>
      </div>
    </div>
  </footer>

  <script>
    const apiKey = '40f1982842db35042e8561b13b38d492';
    const imageBaseUrl = 'https://image.tmdb.org/t/p/';
    let lastModalMovie = null;
    let currentPage = { movies: 1, tvshows: 1, anime: 1, tagalog: 1, netflix: 1, search: 1, favorites: 1 };
    let totalPages = { movies: 1, tvshows: 1, anime: 1, tagalog: 1, netflix: 1, search: 1 };
    let currentMode = 'popular';
    let currentQuery = '';
    let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
    let recentlyViewed = JSON.parse(localStorage.getItem('recently_viewed') || '[]');
    let tvModalData = { tvId: null, season: null, episode: null, seasons: [] };

    // Error Handling
    function showError(message) {
      const div = document.createElement('div');
      div.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-600 text-white p-3 rounded-lg shadow-lg';
      div.textContent = message;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 5000);
    }

    // Progressive Image Loading
    function loadProgressiveImage(img, highResSrc) {
      img.src = highResSrc.replace('/w500', '/w92');
      img.classList.add('poster-img');
      const highRes = new Image();
      highRes.src = highResSrc;
      highRes.onload = () => {
        img.src = highResSrc;
        img.classList.add('loaded');
      };
    }

    // Favorites & Recently Viewed
    function isFavorite(id) { return favorites.includes(id); }
    function toggleFavorite(id) {
      favorites = isFavorite(id) ? favorites.filter(f => f !== id) : [...favorites, id];
      localStorage.setItem('favorites', JSON.stringify(favorites));
      if (currentMode === 'favorites') renderFavorites();
      document.querySelectorAll('.favorite-btn').forEach(btn => {
        if (btn.dataset.id == id) btn.classList.toggle('text-red-500', isFavorite(id));
      });
    }
    function addRecentlyViewed(item) {
      const isTv = !!item.name && !item.title;
      recentlyViewed = recentlyViewed.filter(m => m.id !== item.id || m.isTv !== isTv);
      recentlyViewed.unshift({
        id: item.id,
        title: isTv ? item.name : item.title,
        poster_path: item.poster_path,
        release_date: isTv ? item.first_air_date : item.release_date,
        isTv,
        timestamp: Date.now()
      });
      if (recentlyViewed.length > 12) recentlyViewed = recentlyViewed.slice(0, 12);
      localStorage.setItem('recently_viewed', JSON.stringify(recentlyViewed));
      renderRecentlyViewed();
    }
    function clearRecentlyViewed() {
      recentlyViewed = [];
      localStorage.setItem('recently_viewed', '[]');
      renderRecentlyViewed();
    }
    function renderRecentlyViewed() {
      const section = document.getElementById('recently-viewed-section');
      const list = document.getElementById('recently-viewed-list');
      const clearBtn = document.getElementById('clear-recent-btn');
      if (!recentlyViewed.length) {
        section.style.display = 'none';
        clearBtn.style.display = 'none';
        return;
      }
      section.style.display = 'block';
      clearBtn.style.display = 'block';
      list.innerHTML = '';
      recentlyViewed.sort((a, b) => b.timestamp - a.timestamp).forEach(item => {
        const div = document.createElement('div');
        div.className = 'w-32 flex-shrink-0';
        div.innerHTML = `
          <div class="poster-card cursor-pointer">
            <img src="${item.poster_path ? imageBaseUrl + 'w92' + item.poster_path : 'img/no-poster.png'}" alt="${item.title}" class="poster-img w-full">
            <p class="text-sm text-white mt-2 truncate">${item.title}</p>
          </div>
        `;
        const img = div.querySelector('img');
        if (item.poster_path) loadProgressiveImage(img, imageBaseUrl + 'w500' + item.poster_path);
        div.onclick = () => fetch(`https://api.themoviedb.org/3/${item.isTv ? 'tv' : 'movie'}/${item.id}?api_key=${apiKey}`)
          .then(r => r.json()).then(data => item.isTv ? showTvDetails(data) : showDetails(data));
        list.appendChild(div);
      });
    }

    // Fetch Content
    async function fetchContent(type, page = 1) {
      if (!navigator.onLine) {
        showError('You are offline. Please check your connection.');
        return [];
      }
      let url = '';
      if (type === 'movies') {
        url = `https://api.themoviedb.org/3/trending/movie/day?api_key=${apiKey}&page=${page}`;
      } else if (type === 'tvshows') {
        url = `https://api.themoviedb.org/3/trending/tv/day?api_key=${apiKey}&page=${page}`;
      } else if (type === 'anime') {
        url = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&with_genres=16&with_original_language=ja&sort_by=popularity.desc&page=${page}`;
      } else if (type === 'tagalog') {
        url = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&with_original_language=tl&sort_by=popularity.desc&page=${page}`;
      } else if (type === 'netflix') {
        url = `https://api.themoviedb.org/3/discover/movie?api_key=${apiKey}&with_watch_providers=8&watch_region=US&sort_by=popularity.desc&page=${page}`;
      } else if (type === 'search' && currentQuery.trim()) {
        url = `https://api.themoviedb.org/3/search/multi?api_key=${apiKey}&query=${encodeURIComponent(currentQuery)}&page=${page}&include_adult=false`;
      }
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('API request failed');
        const data = await response.json();
        totalPages[type] = data.total_pages || 1;
        return data.results || [];
      } catch (e) {
        showError('Failed to load content. Please try again.');
        return [];
      }
    }

    // Render Content
    function renderContent(items, containerId, clear = false) {
      const container = document.getElementById(containerId);
      if (clear) container.innerHTML = '';
      if (!items.length) {
        container.innerHTML = '<p class="text-gray-400 col-span-full text-center">No items found.</p>';
        return;
      }
      items.forEach(item => {
        const isTv = item.media_type === 'tv' || !!item.name && !item.title;
        const div = document.createElement('div');
        div.className = 'poster-card';
        div.innerHTML = `
          <div class="relative">
            <img src="${item.poster_path ? imageBaseUrl + 'w92' + item.poster_path : 'img/no-poster.png'}" alt="${isTv ? item.name : item.title}" class="poster-img w-full">
            ${!isTv ? `<button class="absolute top-2 right-2 text-white favorite-btn ${isFavorite(item.id) ? 'text-red-500' : ''}" data-id="${item.id}" aria-label="Toggle favorite"><i class="fas fa-heart"></i></button>` : ''}
            <button class="absolute inset-0 bg-blue-600 bg-opacity-0 hover:bg-opacity-50 transition-opacity rounded-lg flex items-center justify-center play-btn" aria-label="${isTv ? 'View TV Show' : 'Play Movie'}">
              <i class="fas fa-${isTv ? 'tv' : 'play'} text-white text-2xl"></i>
            </button>
          </div>
          <p class="text-sm text-white mt-2 truncate">${isTv ? item.name : item.title}</p>
          <p class="text-xs text-gray-400">${(isTv ? item.first_air_date : item.release_date)?.slice(0, 4) || ''}</p>
        `;
        const img = div.querySelector('img');
        if (item.poster_path) loadProgressiveImage(img, imageBaseUrl + 'w500' + item.poster_path);
        div.querySelector('.play-btn').onclick = () => isTv ? showTvDetails(item) : showDetails(item);
        if (!isTv) div.querySelector('.favorite-btn').onclick = (e) => {
          e.stopPropagation();
          toggleFavorite(item.id);
        };
        container.appendChild(div);
      });
    }

    // Infinite Scroll
    let isLoading = false;
    let reachedEnd = false;
    async function loadMoreContent(type, clear = false) {
      if (isLoading || reachedEnd) return;
      isLoading = true;
      document.getElementById('infinite-loader').style.display = 'block';
      const items = await fetchContent(type, currentPage[type]);
      if (items.length) {
        renderContent(items, `${type}-list`, clear);
        currentPage[type]++;
        if (currentPage[type] > totalPages[type]) reachedEnd = true;
      } else {
        reachedEnd = true;
      }
      isLoading = false;
      document.getElementById('infinite-loader').style.display = 'none';
    }

    // Hero Carousel
    function initCarousel() {
      fetch(`https://api.themoviedb.org/3/trending/all/day?api_key=${apiKey}`)
        .then(r => r.json())
        .then(data => {
          const items = data.results.slice(0, 3);
          items.forEach((item, i) => {
            const div = document.getElementById(`carousel-item-${i + 1}`);
            if (div) {
              div.querySelector('img').src = item.backdrop_path ? imageBaseUrl + 'w1280' + item.backdrop_path : 'img/no-poster.png';
              div.querySelector('h2').textContent = item.title || item.name;
              div.dataset.id = item.id;
              div.dataset.isTv = !!item.name && !item.title;
            }
          });
          document.getElementById('carousel-spinner').style.display = 'none';
          let current = 1;
          setInterval(() => {
            document.querySelectorAll('.carousel-item').forEach(item => item.classList.add('opacity-0'));
            document.getElementById(`carousel-item-${current}`).classList.remove('opacity-0');
            current = current % 3 + 1;
          }, 5000);
        })
        .catch(() => showError('Failed to load carousel.'));
    }

    function playFeatured(index) {
      const item = document.getElementById(`carousel-item-${index}`);
      const id = item.dataset.id;
      const isTv = item.dataset.isTv === 'true';
      fetch(`https://api.themoviedb.org/3/${isTv ? 'tv' : 'movie'}/${id}?api_key=${apiKey}`)
        .then(r => r.json())
        .then(data => isTv ? showTvDetails(data) : showDetails(data));
    }

    // Movie Modal
    async function showDetails(movie) {
      document.getElementById('modal-content-movie').style.display = 'block';
      document.getElementById('modal-content-tv').style.display = 'none';
      document.getElementById('modal').style.display = 'flex';
      lastModalMovie = { id: movie.id, media_type: 'movie' };
      addRecentlyViewed(movie);
      document.getElementById('modal-title').textContent = movie.title;
      document.getElementById('modal-description').textContent = movie.overview || 'No description available.';
      const modalImg = document.getElementById('modal-image');
      if (movie.poster_path) loadProgressiveImage(modalImg, imageBaseUrl + 'w500' + movie.poster_path);
      else modalImg.src = 'img/no-poster.png';
      document.getElementById('modal-rating').innerHTML = `${getStars(movie.vote_average || 0)} (${movie.vote_average || 'N/A'})`;
      document.getElementById('modal-genres').innerHTML = (movie.genres || []).map(g => `<span class="chip">${g.name}</span>`).join(' ');
      document.getElementById('modal-cast').textContent = 'Loading cast...';
      document.getElementById('modal-crew').textContent = '';
      document.getElementById('modal-trailer').innerHTML = '';
      fetch(`https://api.themoviedb.org/3/movie/${movie.id}/credits?api_key=${apiKey}`)
        .then(r => r.json())
        .then(data => {
          const cast = (data.cast || []).slice(0, 5).map(c => c.name).join(', ');
          const director = (data.crew || []).find(c => c.job === 'Director');
          document.getElementById('modal-cast').innerHTML = cast ? `<strong>Cast:</strong> ${cast}` : '';
          document.getElementById('modal-crew').innerHTML = director ? `<strong>Director:</strong> ${director.name}` : '';
        })
        .catch(() => showError('Failed to load credits.'));
      fetch(`https://api.themoviedb.org/3/movie/${movie.id}/videos?api_key=${apiKey}`)
        .then(r => r.json())
        .then(data => {
          const yt = (data.results || []).find(v => v.site === 'YouTube' && v.type === 'Trailer');
          if (yt) {
            document.getElementById('modal-trailer').innerHTML = 'Watch Trailer';
            document.getElementById('modal-trailer').href = `https://youtube.com/watch?v=${yt.key}`;
          }
        });
      document.getElementById('server').value = 'vidsrc.to';
      changeServer();
    }

    function getStars(vote) {
      const stars = Math.round((vote || 0) / 2);
      return '★'.repeat(stars) + '☆'.repeat(5 - stars);
    }

    // TV Modal
    async function showTvDetails(tv) {
      lastModalMovie = { id: tv.id, media_type: 'tv' };
      document.getElementById('modal-content-movie').style.display = 'none';
      document.getElementById('modal-content-tv').style.display = 'block';
      document.getElementById('modal').style.display = 'flex';
      const tvInfo = await fetch(`https://api.themoviedb.org/3/tv/${tv.id}?api_key=${apiKey}`).then(r => r.json());
      tvModalData.tvId = tvInfo.id;
      tvModalData.seasons = tvInfo.seasons;
      document.getElementById('tv-modal-title').textContent = tvInfo.name;
      const modalImg = document.getElementById('tv-modal-image');
      if (tvInfo.poster_path) loadProgressiveImage(modalImg, imageBaseUrl + 'w500' + tvInfo.poster_path);
      else modalImg.src = 'img/no-poster.png';
      document.getElementById('tv-modal-description').textContent = tvInfo.overview || '';
      document.getElementById('tv-modal-air-date').textContent = tvInfo.first_air_date || '';
      document.getElementById('tv-modal-total-seasons').textContent = tvInfo.number_of_seasons;
      document.getElementById('tv-modal-genres').innerHTML = (tvInfo.genres || []).map(g => `<span class="chip">${g.name}</span>`).join(' ');
      document.getElementById('tv-modal-seasons-list').innerHTML = '';
      addRecentlyViewed(tvInfo);
      tvInfo.seasons.forEach(season => {
        const div = document.createElement('div');
        div.className = 'mb-4';
        div.innerHTML = `
          <h3 class="text-lg text-white cursor-pointer" tabindex="0">${season.name} (${season.episode_count} eps)</h3>
          <div class="episodes-list hidden ml-4"></div>
        `;
        const header = div.querySelector('h3');
        header.onclick = async () => {
          const epList = div.querySelector('.episodes-list');
          epList.classList.toggle('hidden');
          if (!epList.innerHTML) {
            const data = await fetch(`https://api.themoviedb.org/3/tv/${tv.id}/season/${season.season_number}?api_key=${apiKey}`).then(r => r.json());
            epList.innerHTML = (data.episodes || []).map(ep => `
              <div class="flex justify-between items-center py-1">
                <span>Ep ${ep.episode_number}: ${ep.name || '(Untitled)'}</span>
                <button class="bg-blue-600 text-white px-2 py-1 rounded" onclick="playTvEpisode('${tv.id}', '${season.season_number}', '${ep.episode_number}')" aria-label="Play episode">Play</button>
              </div>
            `).join('');
          }
        };
        header.onkeydown = e => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            header.click();
          }
        };
        document.getElementById('tv-modal-seasons-list').appendChild(div);
      });
    }

    function playTvEpisode(tvId, seasonNum, episodeNum) {
      const iframe = document.getElementById('tv-episode-player');
      const spinner = document.getElementById('tv-video-spinner');
      iframe.style.display = 'block';
      tvModalData.season = parseInt(seasonNum);
      tvModalData.episode = parseInt(episodeNum);
      changeServer();
      const nextBtn = document.getElementById('tv-episode-next-btn');
      const next = getNextEpisode(tvModalData.season, tvModalData.episode);
      if (next) {
        nextBtn.style.display = 'block';
        nextBtn.onclick = () => playTvEpisode(tvId, next.season, next.episode);
      } else {
        nextBtn.style.display = 'none';
      }
    }

    function getNextEpisode(season, episode) {
      const sidx = tvModalData.seasons.findIndex(s => s.season_number === season);
      if (sidx === -1) return null;
      const currSeason = tvModalData.seasons[sidx];
      if (episode < currSeason.episode_count) {
        return { season: currSeason.season_number, episode: episode + 1 };
      }
      if (sidx + 1 < tvModalData.seasons.length) {
        const nextSeason = tvModalData.seasons[sidx + 1];
        if (nextSeason.episode_count > 0) {
          return { season: nextSeason.season_number, episode: 1 };
        }
      }
      return null;
    }

    function changeServer() {
      if (!lastModalMovie) return;
      const server = document.getElementById('server').value;
      const iframe = document.getElementById(lastModalMovie.media_type === 'tv' ? 'tv-episode-player' : 'modal-video');
      const spinner = document.getElementById(lastModalMovie.media_type === 'tv' ? 'tv-video-spinner' : 'video-spinner');
      let embedURL = '';
      if (server === 'vidsrc.to') {
        embedURL = `https://vidsrc.to/embed/${lastModalMovie.media_type === 'tv' ? `tv/${lastModalMovie.id}/${tvModalData.season}/${tvModalData.episode}` : `movie/${lastModalMovie.id}`}?autoplay=1`;
      } else if (server === 'vidsrc.me') {
        embedURL = `https://vidsrc.me/embed/${lastModalMovie.media_type === 'tv' ? `tv?tmdb=${lastModalMovie.id}&season=${tvModalData.season}&episode=${tvModalData.episode}` : `movie/${lastModalMovie.id}`}?autoplay=1`;
      } else {
        embedURL = `https://vidsrc.cc/api/embed/${lastModalMovie.media_type === 'tv' ? `tv/${lastModalMovie.id}/${tvModalData.season}/${tvModalData.episode}` : `movie/${lastModalMovie.id}`}?autoplay=1`;
      }
      spinner.style.display = 'block';
      iframe.src = embedURL;
      iframe.onload = () => spinner.style.display = 'none';
      iframe.onerror = () => {
        spinner.style.display = 'none';
        const nextServer = server === 'vidsrc.to' ? 'vidsrc.me' : server === 'vidsrc.me' ? 'vidsrc.cc' : 'vidsrc.to';
        document.getElementById('server').value = nextServer;
        changeServer();
        showError(`Server ${server} failed. Switching to ${nextServer}.`);
      };
    }

    function closeModal() {
      document.getElementById('modal').style.display = 'none';
      document.getElementById('modal-video').src = '';
      document.getElementById('tv-episode-player').style.display = 'none';
      document.getElementById('tv-episode-player').src = '';
      document.getElementById('tv-episode-next-btn').style.display = 'none';
    }

    // Search Modal
    function openSearchModal() {
      document.getElementById('search-modal').style.display = 'flex';
      document.getElementById('search-input').focus();
    }
    function closeSearchModal() {
      document.getElementById('search-modal').style.display = 'none';
      document.getElementById('search-input').value = '';
      document.getElementById('search-results').innerHTML = '';
    }
    async function searchTMDB() {
      const query = document.getElementById('search-input').value.trim();
      if (!query) {
        document.getElementById('search-results').innerHTML = '';
        return;
      }
      try {
        const data = await fetch(`https://api.themoviedb.org/3/search/multi?api_key=${apiKey}&query=${encodeURIComponent(query)}&page=1&include_adult=false`).then(r => r.json());
        const results = data.results || [];
        document.getElementById('search-results').innerHTML = results.slice(0, 10).map(item => {
          const isTv = item.media_type === 'tv' || !!item.name && !item.title;
          return `
            <div class="flex gap-4 p-2 hover:bg-gray-800 rounded-lg cursor-pointer" onclick="selectSearchResult(${item.id}, '${isTv ? 'tv' : 'movie'}')">
              <img src="${item.poster_path ? imageBaseUrl + 'w92' + item.poster_path : 'img/no-poster.png'}" alt="${isTv ? item.name : item.title}" class="w-16 rounded">
              <div>
                <p class="text-white">${isTv ? item.name : item.title}</p>
                <p class="text-gray-400 text-sm">${(isTv ? item.first_air_date : item.release_date)?.slice(0, 4) || ''}</p>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        showError('Search failed. Please try again.');
      }
    }
    function selectSearchResult(id, type) {
      fetch(`https://api.themoviedb.org/3/${type}/${id}?api_key=${apiKey}`)
        .then(r => r.json())
        .then(data => {
          closeSearchModal();
          type === 'tv' ? showTvDetails(data) : showDetails(data);
        });
    }

    // Favorites
    function renderFavorites() {
      document.getElementById('favorites-section').style.display = 'block';
      document.querySelectorAll('.mb-8').forEach(s => { if (s.id !== 'favorites-section') s.style.display = 'none'; });
      const container = document.getElementById('favorites-list');
      if (!favorites.length) {
        container.innerHTML = '<p class="text-gray-400 col-span-full text-center">No favorites yet.</p>';
        return;
      }
      Promise.all(favorites.map(id =>
        fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=${apiKey}`).then(r => r.json())
      )).then(arr => renderContent(arr.filter(m => m && m.id), 'favorites-list', true));
    }

    // Navigation
    function switchMode(mode) {
      if (currentMode === mode && !(mode === 'search' && currentQuery)) return;
      currentMode = mode;
      document.querySelectorAll('.navbar a').forEach(a => a.classList.remove('active'));
      document.getElementById(`nav-${mode}`).classList.add('active');
      document.getElementById(`nav-mobile-${mode}`).classList.add('active');
      document.querySelectorAll('.mb-8').forEach(s => s.style.display = 'block');
      document.getElementById('favorites-section').style.display = 'none';
      if (mode === 'favorites') {
        renderFavorites();
        reachedEnd = true;
      } else {
        currentPage[mode] = 1;
        reachedEnd = false;
        loadMoreContent(mode, true);
      }
    }

    // Sharing
    function shareMovie() {
      if (!lastModalMovie) return;
      const url = `${location.origin}${location.pathname}?mid=${lastModalMovie.id}`;
      if (navigator.share) {
        navigator.share({ title: lastModalMovie.title, text: 'Check out this movie on MovieDck!', url });
      } else {
        navigator.clipboard.writeText(url);
        showError('Link copied to clipboard!');
      }
    }
    function shareTvShow() {
      const title = document.getElementById('tv-modal-title').textContent;
      if (!title) return;
      const url = location.href.split('?')[0];
      if (navigator.share) {
        navigator.share({ title, text: 'Check out this TV show on MovieDck!', url });
      } else {
        navigator.clipboard.writeText(url);
        showError('Link copied to clipboard!');
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      // Navbar Scroll Effect
      window.addEventListener('scroll', () => {
        document.querySelector('.navbar').classList.toggle('scrolled', window.scrollY > 50);
      });

      // Mobile Menu
      document.getElementById('mobile-menu-btn').onclick = () => {
        document.getElementById('mobile-menu').classList.toggle('hidden');
      };

      // Navigation
      ['movies', 'tvshows', 'anime', 'tagalog', 'netflix', 'favorites'].forEach(mode => {
        document.getElementById(`nav-${mode}`).onclick = e => {
          e.preventDefault();
          switchMode(mode);
        };
        document.getElementById(`nav-mobile-${mode}`).onclick = e => {
          e.preventDefault();
          switchMode(mode);
          document.getElementById('mobile-menu').classList.add('hidden');
        };
      });

      // Infinite Scroll
      window.addEventListener('scroll', () => {
        if (reachedEnd || isLoading || currentMode === 'favorites') return;
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
          loadMoreContent(currentMode);
        }
      });

      // Clear Recently Viewed
      document.getElementById('clear-recent-btn').onclick = clearRecentlyViewed;

      // Load Initial Content
      renderRecentlyViewed();
      initCarousel();
      loadMoreContent('movies', true);
      loadMoreContent('tvshows', true);
      loadMoreContent('anime', true);
      loadMoreContent('tagalog', true);
      loadMoreContent('netflix', true);
    });
  </script>
</body>
</html>